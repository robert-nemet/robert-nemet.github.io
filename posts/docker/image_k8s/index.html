<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes | DevCube</title>
<meta name=keywords content="docker,kubernetes"><meta name=description content="After building a Docker image faster, I wanted to build it for the K8s cluster. Running the container on the local machine isn&rsquo;t the same as running it on a cluster. I&rsquo;m packaging a Go application in my example. But the same principles apply to any other language.
Starting Dockerfile I&rsquo;m starting with the following Dockerfile(Dockerfile_1):
ARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY ."><meta name=author content="Robert Nemet"><link rel=canonical href=https://rnemet.dev/posts/docker/image_k8s/><link crossorigin=anonymous href=/assets/css/stylesheet.9329d037bc79464b26647fb72e079cd738f5d2418b1df4da3b515db9e22cb4d9.css integrity="sha256-kynQN7x5RksmZH+3Lgec1zj10kGLHfTaO1FdueIstNk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://rnemet.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rnemet.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rnemet.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://rnemet.dev/apple-touch-icon.png><link rel=mask-icon href=https://rnemet.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-L148RQBR36"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-L148RQBR36",{anonymize_ip:!1})}</script><meta property="og:title" content="Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes"><meta property="og:description" content="After building a Docker image faster, I wanted to build it for the K8s cluster. Running the container on the local machine isn&rsquo;t the same as running it on a cluster. I&rsquo;m packaging a Go application in my example. But the same principles apply to any other language.
Starting Dockerfile I&rsquo;m starting with the following Dockerfile(Dockerfile_1):
ARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY ."><meta property="og:type" content="article"><meta property="og:url" content="https://rnemet.dev/posts/docker/image_k8s/"><meta property="og:image" content="https://rnemet.dev/images/scratch_cube.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-14T15:43:46+02:00"><meta property="article:modified_time" content="2023-04-14T15:43:46+02:00"><meta property="og:site_name" content="DevCube"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rnemet.dev/images/scratch_cube.png"><meta name=twitter:title content="Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes"><meta name=twitter:description content="After building a Docker image faster, I wanted to build it for the K8s cluster. Running the container on the local machine isn&rsquo;t the same as running it on a cluster. I&rsquo;m packaging a Go application in my example. But the same principles apply to any other language.
Starting Dockerfile I&rsquo;m starting with the following Dockerfile(Dockerfile_1):
ARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rnemet.dev/posts/"},{"@type":"ListItem","position":2,"name":"Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes","item":"https://rnemet.dev/posts/docker/image_k8s/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes","name":"Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes","description":"After building a Docker image faster, I wanted to build it for the K8s cluster. Running the container on the local machine isn\u0026rsquo;t the same as running it on a cluster. I\u0026rsquo;m packaging a Go application in my example. But the same principles apply to any other language.\nStarting Dockerfile I\u0026rsquo;m starting with the following Dockerfile(Dockerfile_1):\nARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY .","keywords":["docker","kubernetes"],"articleBody":"After building a Docker image faster, I wanted to build it for the K8s cluster. Running the container on the local machine isn’t the same as running it on a cluster. I’m packaging a Go application in my example. But the same principles apply to any other language.\nStarting Dockerfile I’m starting with the following Dockerfile(Dockerfile_1):\nARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY . /app/ RUN go build -o app FROM debian:buster WORKDIR /app COPY --from=builder /app/app /app/ ENTRYPOINT [ \"/app/app\" ] And I build it with the following command:\ndocker buildx build -t rnemet/echo:0.0.1 . -f Dockerfile_1 --cache-to type=registry,ref=rnemet/echo:test --cache-from type=registry,ref=rnemet/echo:test --cache-from type=registry,ref=rnemet/echo:main --load I’m using the --cache-to and --cache-from flags to cache the build process and the --load to load the image into the local Docker daemon. Also, I’m using BuildKit to build an image.\nLet’s see what I got:\n❯ docker images rnemet/echo REPOSITORY TAG IMAGE ID CREATED SIZE rnemet/echo 0.0.1 6fc43a3d85eb 4 minutes ago 133MB If I run the container as a Pod in a K8s cluster or a Docker container on my local machine:\n❯ docker exec -it echo bash root@30fa7aa78401:/app# whoami root I managed:\nto open a shell in the container found out that I’m running as root I run the whoami command, which is not a command I need when I run the container The whoami is not the problem, but the fact that it is present. I don’t need it, and it’s not part of my application. There must be others as well. I need to clean up the image.\nThen I learned that my app is run as root. This isn’t good. My app needs to run as a non-root user. Why? There are many reasons. For example, the app can access the whole system with root privileges. Do you remember? The container runtime isolates the process from the host system using namespaces. But the process can still access the host system.\nAs the cherry on top, I can open a shell in the container and run commands as root. I do not even want to discuss why this is not good.\nSmaller, Rootless, and Non-Shell Image The first thing I have to do is to change the target image. I’m using debian:buster as a target image. That needs to be changed. I decided to use scratch as a target image. It’s a minimal image. It’s not a Linux distribution. It’s not a shell. It’s not a root user. It’s a blank slate. So my next Dockerfile(Dockerfile_2):\nARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY . /app/ RUN go build -o app FROM scratch WORKDIR /app COPY --from=builder /app/app /app/ ENTRYPOINT [ \"/app/app\" ] And build it:\ndocker buildx build -t rnemet/echo:0.0.2 . -f Dockerfile_2 --cache-to type=registry,ref=rnemet/echo:test --cache-from type=registry,ref=rnemet/echo:test --cache-from type=registry,ref=rnemet/echo:main --load And the result:\n❯ docker images rnemet/echo REPOSITORY TAG IMAGE ID CREATED SIZE rnemet/echo 0.0.2 188f310d88e2 42 seconds ago 19.1MB rnemet/echo 0.0.1 6fc43a3d85eb 59 minutes ago 133MB Wow, the image is smaller. But it fails when I try to run it as a Pod in a K8s cluster or a Docker container on my local machine. Argh…\nThe problem is how I build the application. I’m building it on a particular Linux image with Go installed. That means all the libs and tools that Go needs to build and run the application are part of the image. So, I must build the app with all its dependencies packed together. When it comes to Go, it’s easy(Dockerfile_3):\n... RUN CGO_ENABLED=0 go build -ldflags=\"-s -w\" -o app ... I’m using the CGO_ENABLED=0 flag to disable using Cgo. I’m using the -ldflags=\"-s -w\" flag to strip the debug information from the binary. And results are:\n❯ docker images rnemet/echo REPOSITORY TAG IMAGE ID CREATED SIZE rnemet/echo 0.0.3 81e4098f0e76 15 seconds ago 13MB rnemet/echo 0.0.2 188f310d88e2 25 minutes ago 19.1MB rnemet/echo 0.0.1 6fc43a3d85eb About an hour ago 133MB The image is smaller, and it works. But I’m still running it as root. I need to change that, too. But when working with scratch image, I need to create the user in the builder image and then copy the /etc/password file to the scratch image(Dockerfile_3):\nARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY . /app/ RUN CGO_ENABLED=0 go build -ldflags=\"-s -w\" -o app RUN useradd -u 10001 appuser FROM scratch WORKDIR /app COPY --from=builder /etc/passwd /etc/passwd USER appuser COPY --chown=appuser:appuser --from=builder /app/app /app/ ENTRYPOINT [ \"/app/app\" ] I’m running as a non-root user with no shell, and the image is smaller. And I should be happy, but no. Why? Let’s go a few steps back.\nWhy Is Image Smaller? In this case, the image is smaller because I’m using a scratch image as a target image, which produces an image size of around 19MB. Plus, I’m using stripping debugging information from the binary. That’s why the image is so small. That is nice, right?\nCgo Or No Cgo? I’m using the CGO_ENABLED=0 flag to disable using Cgo. Why? Because I’m using a scratch image as a target image.\nIf I use debian:buster as a target image, I don’t need to disable Cgo. Why? Because debian:buster image has all the libs and tools that Go needs to build and run the application. So I don’t need to pack all the libs and tools with the application. I can use the libs and tools that are part of the image.\nThe cgo tool is a tool that allows Go programs to call C code. It enables your Go app to call OS’s native libraries dynamically. Using it leads to smaller and faster builds. But, as you can see, it is not always possible to use it. So, in this case, I have to disable it and create a static binary. The static binary will be bigger but will have all the libs the app needs to run. It will be more portable. It is common to disable cgo when creating multi-architecture images.\nUnless your app depends on C libraries, you can generally disable cgo. Then you have to leave cgo enabled. It’s always some trade-off.\nDo I Always Need To Scratch When It Itches? While the scratch image is minimal, it uses the root user, and I can not use the USER instruction to change it. I had to do a workaround. See Dockerfile_3. I had to add the user to the builder image and then copy /etc/password file to the scratch image. Not a big deal, but it’s a workaround. And I’m not too fond of workarounds. I wonder if it is the only workaround I will do when using the scratch image.\nSmall detour. You need a base image that you can trust and use easily. When choosing a base image, you should trust the creator of the base image, and you don’t want to make any changes or workarounds. In most cases, you’ll see Alpine Linux because it is small, and people trust it. But it has its own problems. My personal choice is Distroless images. They are small, secure, and easy to use. It is not as small as a scratch image, but still small. And they are secure. They are based on Debian, and they use non-root user. So you don’t need to do any workarounds.\nLet’s check it out. I’m using distroless/static-debian11:nonroot as a target image(Dockerfile_4):\nARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY . /app/ RUN CGO_ENABLED=0 go build -ldflags=\"-s -w\" -o app FROM gcr.io/distroless/static-debian11:nonroot WORKDIR /app COPY --from=builder /app/app /app/ ENTRYPOINT [ \"/app/app\" ] And results are:\n❯ docker images rnemet/echo REPOSITORY TAG IMAGE ID CREATED SIZE rnemet/echo 0.0.4 f04110959f3c About a minute ago 15.5MB rnemet/echo 0.0.3 0280e6cfb546 5 hours ago 13MB rnemet/echo 0.0.2 188f310d88e2 6 hours ago 19.1MB rnemet/echo 0.0.1 6fc43a3d85eb 7 hours ago 133MB Using distroless/static-debian11:nonroot as a target image, I’m getting an image size of around 15.5MB. And I’m running as a non-root user. I do not have any workarounds. As well, I’m having USER instruction. My Dockerfile is clean and easy to read. I like it.\nOne last try to use cgo in Dockerfile_5:\nARG GO_VERSION=1.20.3 FROM golang:${GO_VERSION}-buster as builder WORKDIR /app COPY go.mod go.sum /app/ RUN go mod download -x COPY . /app/ RUN go build -ldflags=\"-s -w\" -o app FROM gcr.io/distroless/base-debian11:nonroot WORKDIR /app COPY --from=builder /app/app /app/ ENTRYPOINT [ \"/app/app\" ] After building it, the results are:\n❯ docker images rnemet/echo REPOSITORY TAG IMAGE ID CREATED SIZE rnemet/echo 0.0.5 030cf87dd36e 3 minutes ago 33.5MB rnemet/echo 0.0.4 f04110959f3c 15 minutes ago 15.5MB rnemet/echo 0.0.3 0280e6cfb546 5 hours ago 13MB rnemet/echo 0.0.2 188f310d88e2 6 hours ago 19.1MB rnemet/echo 0.0.1 6fc43a3d85eb 7 hours ago 133MB So, the smallest image is when we use a scratch image as a target image. But we have to do some workarounds. The second smallest image is when we use distroless/static-debian11:nonroot as a target image. And we don’t have to do any workarounds.\nWhen you compare Distrolees images with a scratch image, you can see that the second is smaller. But, I trust Google and do not have to do any workarounds if I use Distrolees images. In the case of the Go app, I had only one workaround. If I need to pack another app based on Java or NodeJS, I could do more work using a scratch image. Distrolees images already come prepackaged with some tools. So I don’t have to do any workarounds.\nBase Image Conclusion Let’s summarize the results:\nimage:tag base image size non-user no-shell comments rnemet/echo:0.0.1 debian:buster 33.5MB no no - rnemet/echo:0.0.2 scratch 19.1MB no no do not work rnemet/echo:0.0.3 scratch 13MB yes yes static build, strip debug information, requires workaround for non-root user rnemet/echo:0.0.4 distroless/static-debian11:nonroot 15.5MB yes yes static build, strip debug information rnemet/echo:0.0.5 distroless/base-debian11:nonroot 33.5MB no no - In the end, I got what I wanted, a fast build, a small image, a non-root user, no shell access, and no workarounds. I’m happy with the results.\nI’m not telling you to use Distroless images without any doubts. Maybe for your case, Alpine Linux](https://hub.docker.com/_/alpine) is better as it is tiny. Or you prefer Wolfi. Or start from scratch. As you can see, there will be some trade-offs. You need to consider your apps needs, the effort willing to put into your Dockerfile and your trust in the creator of the base image.\nAh, one more thing please try to avoid the latest tags. Use versioned base images whenever possible. You’ll have much more control and less headache.\nNice to Have: Labels Add some metadata to your images. They can be handy later on. Like:\nLABEL version=\"0.0.1-beta\" LABEL vendor=\"rnemet.dev\" LABEL release-date=\"2024-02-12\" You could also use ARG to set labels. Like:\nARG VERSION=0.0.1-beta ARG VENDOR=rnemet.dev ARG RELEASE_DATE=2024-02-12 LABEL version=\"0.0.1-beta\" LABEL vendor=\"rnemet.dev\" LABEL release-date=\"2024-02-12\" Conclusion I hope you enjoyed this post and learned something new. If you found this helpful post, please share it with your friends. You can subscribe to my newsletter at the bottom of this post and/or share this post. I would appreciate it.\nReferences BuildKit Linux namespaces Docker user namespaces Scratch image Building image from scratch Distroless images Wolfi Alpine Linux ","wordCount":"1879","inLanguage":"en","image":"https://rnemet.dev/images/scratch_cube.png","datePublished":"2023-04-14T15:43:46+02:00","dateModified":"2023-04-14T15:43:46+02:00","author":{"@type":"Person","name":"Robert Nemet"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rnemet.dev/posts/docker/image_k8s/"},"publisher":{"@type":"Organization","name":"DevCube","logo":{"@type":"ImageObject","url":"https://rnemet.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rnemet.dev/ accesskey=h title="Home (Alt + H)"><img src=https://rnemet.dev/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rnemet.dev/posts/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://rnemet.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://rnemet.dev/posts/practical_k8s/ title="Practical k8s"><span>Practical k8s</span></a></li><li><a href=https://rnemet.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://rnemet.dev/about/ title="About Me"><span>About Me</span></a></li><li><a href=https://rnemet.dev/ title><span></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes</h1><div class=post-description></div><div class=post-meta><span title='2023-04-14 15:43:46 +0200 CEST'>April 14, 2023</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Robert Nemet</div></header><figure class=entry-cover><img loading=lazy src=https://rnemet.dev/images/scratch_cube.png alt><p></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#starting-dockerfile aria-label="Starting Dockerfile">Starting Dockerfile</a></li><li><a href=#smaller-rootless-and-non-shell-image aria-label="Smaller, Rootless, and Non-Shell Image">Smaller, Rootless, and Non-Shell Image</a><ul><li><a href=#why-is-image-smaller aria-label="Why Is Image Smaller?">Why Is Image Smaller?</a></li><li><a href=#cgo-or-no-cgo aria-label="Cgo Or No Cgo?">Cgo Or No Cgo?</a></li><li><a href=#do-i-always-need-to-scratch-when-it-itches aria-label="Do I Always Need To Scratch When It Itches?">Do I Always Need To Scratch When It Itches?</a></li><li><a href=#base-image-conclusion aria-label="Base Image Conclusion">Base Image Conclusion</a></li></ul></li><li><a href=#nice-to-have-labels aria-label="Nice to Have: Labels">Nice to Have: Labels</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>After building <a href=https://rnemet.dev/posts/docker/building_image_fast/>a Docker image faster</a>, I wanted to build it for the K8s cluster. Running the container on
the local machine isn&rsquo;t the same as running it on a cluster. I&rsquo;m packaging a Go application in my example. But the same principles apply to any other language.</p><h2 id=starting-dockerfile>Starting Dockerfile<a hidden class=anchor aria-hidden=true href=#starting-dockerfile>#</a></h2><p>I&rsquo;m starting with the following Dockerfile(Dockerfile_1):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> GO_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.20.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:${GO_VERSION}-buster as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> go.mod go.sum /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod download -x<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go build -o app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> debian:buster</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/app /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/app/app&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>And I build it with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker buildx build -t rnemet/echo:0.0.1 . -f Dockerfile_1 --cache-to type<span style=color:#f92672>=</span>registry,ref<span style=color:#f92672>=</span>rnemet/echo:test --cache-from type<span style=color:#f92672>=</span>registry,ref<span style=color:#f92672>=</span>rnemet/echo:test --cache-from type<span style=color:#f92672>=</span>registry,ref<span style=color:#f92672>=</span>rnemet/echo:main --load
</span></span></code></pre></div><p>I&rsquo;m using the <code>--cache-to</code> and <code>--cache-from</code> flags to cache the build process and the <code>--load</code> to load the image into the local Docker daemon. Also, I&rsquo;m using BuildKit to build an image.</p><p>Let&rsquo;s see what I got:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ docker images rnemet/echo
</span></span><span style=display:flex><span>REPOSITORY    TAG       IMAGE ID       CREATED         SIZE
</span></span><span style=display:flex><span>rnemet/echo   0.0.1     6fc43a3d85eb   <span style=color:#ae81ff>4</span> minutes ago   133MB
</span></span></code></pre></div><p>If I run the container as a Pod in a K8s cluster or a Docker container on my local machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ docker exec -it  echo bash
</span></span><span style=display:flex><span>root@30fa7aa78401:/app# whoami
</span></span><span style=display:flex><span>root
</span></span></code></pre></div><p>I managed:</p><ul><li>to open a shell in the container</li><li>found out that I&rsquo;m running as root</li><li>I run the <code>whoami</code> command, which is not a command I need when I run the container</li></ul><p>The <code>whoami</code> is not the problem, but the fact that it is present. I don&rsquo;t need it, and it&rsquo;s not part of my application. There must be others as well. I need to
clean up the image.</p><p>Then I learned that my app is run as root. This isn&rsquo;t good. My app needs to run as a non-root user. Why? There are many reasons. For example, the app can access the
whole system with root privileges. Do you remember? The container runtime isolates the process from the host system using <a href=https://www.linux.com/news/understanding-and-securing-linux-namespaces/>namespaces</a>. But the process can still access the host system.</p><p>As the cherry on top, I can open a shell in the container and run commands as root. I do not even want to discuss why this is not good.</p><h2 id=smaller-rootless-and-non-shell-image>Smaller, Rootless, and Non-Shell Image<a hidden class=anchor aria-hidden=true href=#smaller-rootless-and-non-shell-image>#</a></h2><p>The first thing I have to do is to change the target image. I&rsquo;m using <code>debian:buster</code> as a target image. That needs to be changed. I decided to use <code>scratch</code> as a
target image. It&rsquo;s a minimal image. It&rsquo;s not a Linux distribution. It&rsquo;s not a shell. It&rsquo;s not a root user. It&rsquo;s a blank slate. So my next Dockerfile(Dockerfile_2):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> GO_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.20.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:${GO_VERSION}-buster as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> go.mod go.sum /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod download -x<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go build -o app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> scratch</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/app /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/app/app&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>And build it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker buildx build -t rnemet/echo:0.0.2 . -f Dockerfile_2 --cache-to type<span style=color:#f92672>=</span>registry,ref<span style=color:#f92672>=</span>rnemet/echo:test --cache-from type<span style=color:#f92672>=</span>registry,ref<span style=color:#f92672>=</span>rnemet/echo:test --cache-from type<span style=color:#f92672>=</span>registry,ref<span style=color:#f92672>=</span>rnemet/echo:main --load
</span></span></code></pre></div><p>And the result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ docker images rnemet/echo
</span></span><span style=display:flex><span>REPOSITORY    TAG       IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>rnemet/echo   0.0.2     188f310d88e2   <span style=color:#ae81ff>42</span> seconds ago   19.1MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.1     6fc43a3d85eb   <span style=color:#ae81ff>59</span> minutes ago   133MB
</span></span></code></pre></div><p>Wow, the image is smaller. But it fails when I try to run it as a Pod in a K8s cluster or a Docker container on my local machine. Argh&mldr;</p><p>The problem is how I build the application. I&rsquo;m building it on a particular Linux image with Go installed. That means all the libs and tools that Go needs to build and
run the application are part of the image. So, I must build the app with all its dependencies packed together. When it comes to Go, it&rsquo;s easy(Dockerfile_3):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span>...<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> CGO_ENABLED<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> go build -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-s -w&#34;</span> -o app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>...<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>I&rsquo;m using the <code>CGO_ENABLED=0</code> flag to disable using Cgo. I&rsquo;m using the <code>-ldflags="-s -w"</code> flag to strip the debug information from the binary. And results are:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ docker images rnemet/echo
</span></span><span style=display:flex><span>REPOSITORY    TAG       IMAGE ID       CREATED             SIZE
</span></span><span style=display:flex><span>rnemet/echo   0.0.3     81e4098f0e76   <span style=color:#ae81ff>15</span> seconds ago      13MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.2     188f310d88e2   <span style=color:#ae81ff>25</span> minutes ago      19.1MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.1     6fc43a3d85eb   About an hour ago   133MB
</span></span></code></pre></div><p>The image is smaller, and it works. But I&rsquo;m still running it as root. I need to change that, too. But when working with <code>scratch</code> image, I need to create the user in
the <code>builder</code> image and then copy the <code>/etc/password</code> file to the <code>scratch</code> image(Dockerfile_3):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> GO_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.20.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:${GO_VERSION}-buster as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> go.mod go.sum /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod download -x<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> CGO_ENABLED<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> go build -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-s -w&#34;</span> -o app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> useradd -u <span style=color:#ae81ff>10001</span> appuser<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> scratch</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /etc/passwd /etc/passwd<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> appuser</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --chown<span style=color:#f92672>=</span>appuser:appuser --from<span style=color:#f92672>=</span>builder /app/app /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/app/app&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>I&rsquo;m running as a non-root user with no shell, and the image is smaller. And I should be happy, but no. Why? Let&rsquo;s go a few steps back.</p><h3 id=why-is-image-smaller>Why Is Image Smaller?<a hidden class=anchor aria-hidden=true href=#why-is-image-smaller>#</a></h3><p>In this case, the image is smaller because I&rsquo;m using a <code>scratch</code> image as a target image, which produces an image size of around 19MB. Plus, I&rsquo;m using stripping
debugging information from the binary. That&rsquo;s why the image is so small. That is nice, right?</p><h3 id=cgo-or-no-cgo>Cgo Or No Cgo?<a hidden class=anchor aria-hidden=true href=#cgo-or-no-cgo>#</a></h3><p>I&rsquo;m using the <code>CGO_ENABLED=0</code> flag to disable using Cgo. Why? Because I&rsquo;m using a <code>scratch</code> image as a target image.</p><p>If I use <code>debian:buster</code> as a target image, I don&rsquo;t need to disable Cgo. Why? Because <code>debian:buster</code> image has all the libs and tools that Go needs to build and run
the application. So I don&rsquo;t need to pack all the libs and tools with the application. I can use the libs and tools that are part of the image.</p><p>The <code>cgo</code> tool is a tool that allows Go programs to call C code. It enables your Go app to call OS&rsquo;s native libraries dynamically. Using it leads to smaller and faster
builds. But, as you can see, it is not always possible to use it. So, in this case, I have to disable it and create a static binary. The static binary will be bigger
but will have all the libs the app needs to run. It will be more portable. It is common to disable <code>cgo</code> when creating multi-architecture images.</p><p>Unless your app depends on C libraries, you can generally disable <code>cgo</code>. Then you have to leave <code>cgo</code> enabled. It&rsquo;s always some trade-off.</p><h3 id=do-i-always-need-to-scratch-when-it-itches>Do I Always Need To Scratch When It Itches?<a hidden class=anchor aria-hidden=true href=#do-i-always-need-to-scratch-when-it-itches>#</a></h3><p>While the <code>scratch</code> image is minimal, it uses the <code>root</code> user, and I can not use the <code>USER</code> instruction to change it. I had to do a workaround. See Dockerfile_3. I had
to add the user to the <code>builder</code> image and then copy <code>/etc/password</code> file to the <code>scratch</code> image. Not a big deal, but it&rsquo;s a workaround. And I&rsquo;m not too fond of
workarounds. I wonder if it is the only workaround I will do when using the <code>scratch</code> image.</p><p>Small detour. You need a base image that you can trust and use easily. When choosing a base image, you should trust the creator of the base image, and you don&rsquo;t want
to make any changes or workarounds. In most cases, you&rsquo;ll see Alpine Linux because it is small, and people trust it. But it has its own <a href=https://martinheinz.dev/blog/92>problems</a>. My personal choice is <a href=https://github.com/GoogleContainerTools/distroless>Distroless images</a>. They are small, secure, and easy to use. It is not as
small as a <code>scratch</code> image, but still small. And they are secure. They are based on Debian, and they use <code>non-root</code> user. So you don&rsquo;t need to do any workarounds.</p><p>Let&rsquo;s check it out. I&rsquo;m using <code>distroless/static-debian11:nonroot</code> as a target image(Dockerfile_4):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> GO_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.20.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:${GO_VERSION}-buster as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> go.mod go.sum /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod download -x<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> CGO_ENABLED<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> go build -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-s -w&#34;</span> -o app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> gcr.io/distroless/static-debian11:nonroot</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/app /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/app/app&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>And results are:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ docker images rnemet/echo
</span></span><span style=display:flex><span>REPOSITORY    TAG       IMAGE ID       CREATED              SIZE
</span></span><span style=display:flex><span>rnemet/echo   0.0.4     f04110959f3c   About a minute ago   15.5MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.3     0280e6cfb546   <span style=color:#ae81ff>5</span> hours ago          13MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.2     188f310d88e2   <span style=color:#ae81ff>6</span> hours ago          19.1MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.1     6fc43a3d85eb   <span style=color:#ae81ff>7</span> hours ago          133MB
</span></span></code></pre></div><p>Using <code>distroless/static-debian11:nonroot</code> as a target image, I&rsquo;m getting an image size of around 15.5MB. And I&rsquo;m running as a non-root user. I do not have any
workarounds. As well, I&rsquo;m having <code>USER</code> instruction. My Dockerfile is clean and easy to read. I like it.</p><p>One last try to use <code>cgo</code> in Dockerfile_5:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> GO_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.20.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:${GO_VERSION}-buster as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> go.mod go.sum /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod download -x<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go build -ldflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-s -w&#34;</span> -o app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> gcr.io/distroless/base-debian11:nonroot</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/app /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [ <span style=color:#e6db74>&#34;/app/app&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>After building it, the results are:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ docker images rnemet/echo
</span></span><span style=display:flex><span>REPOSITORY    TAG       IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>rnemet/echo   0.0.5     030cf87dd36e   <span style=color:#ae81ff>3</span> minutes ago    33.5MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.4     f04110959f3c   <span style=color:#ae81ff>15</span> minutes ago   15.5MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.3     0280e6cfb546   <span style=color:#ae81ff>5</span> hours ago      13MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.2     188f310d88e2   <span style=color:#ae81ff>6</span> hours ago      19.1MB
</span></span><span style=display:flex><span>rnemet/echo   0.0.1     6fc43a3d85eb   <span style=color:#ae81ff>7</span> hours ago      133MB
</span></span></code></pre></div><p>So, the smallest image is when we use a <code>scratch</code> image as a target image. But we have to do some workarounds. The second smallest image is when we use
<code>distroless/static-debian11:nonroot</code> as a target image. And we don&rsquo;t have to do any workarounds.</p><p>When you compare Distrolees images with a <code>scratch</code> image, you can see that the second is smaller. But, I trust Google and do not have to do any workarounds if I use
Distrolees images. In the case of the Go app, I had only one workaround. If I need to pack another app based on Java or NodeJS, I could do more work using a <code>scratch</code>
image. Distrolees images already come prepackaged with some tools. So I don&rsquo;t have to do any workarounds.</p><h3 id=base-image-conclusion>Base Image Conclusion<a hidden class=anchor aria-hidden=true href=#base-image-conclusion>#</a></h3><p>Let&rsquo;s summarize the results:</p><table><thead><tr><th>image:tag</th><th>base image</th><th>size</th><th>non-user</th><th>no-shell</th><th>comments</th></tr></thead><tbody><tr><td>rnemet/echo:0.0.1</td><td>debian:buster</td><td>33.5MB</td><td>no</td><td>no</td><td>-</td></tr><tr><td>rnemet/echo:0.0.2</td><td>scratch</td><td>19.1MB</td><td>no</td><td>no</td><td>do not work</td></tr><tr><td>rnemet/echo:0.0.3</td><td>scratch</td><td>13MB</td><td>yes</td><td>yes</td><td>static build, strip debug information, requires workaround for non-root user</td></tr><tr><td>rnemet/echo:0.0.4</td><td>distroless/static-debian11:nonroot</td><td>15.5MB</td><td>yes</td><td>yes</td><td>static build, strip debug information</td></tr><tr><td>rnemet/echo:0.0.5</td><td>distroless/base-debian11:nonroot</td><td>33.5MB</td><td>no</td><td>no</td><td>-</td></tr></tbody></table><p>In the end, I got what I wanted, a fast build, a small image, a non-root user, no shell access, and no workarounds. I&rsquo;m happy with the results.</p><p>I&rsquo;m not telling you to use Distroless images without any doubts. Maybe for your case, <a href=https://hub.docker.com/_/alpine>Alpine Linux</a>](<a href=https://hub.docker.com/_/alpine>https://hub.docker.com/_/alpine</a>) is better as it is tiny.
Or you prefer <a href=https://github.com/wolfi-dev/>Wolfi</a>. Or start from <code>scratch</code>. As you can see, there will be some trade-offs. You need to consider your apps needs, the effort willing to put into your Dockerfile and your trust in the creator of the base image.</p><p>Ah, one more thing please try to avoid the latest tags. Use versioned base images whenever possible. You&rsquo;ll have much more control and less headache.</p><h2 id=nice-to-have-labels>Nice to Have: Labels<a hidden class=anchor aria-hidden=true href=#nice-to-have-labels>#</a></h2><p>Add some metadata to your images. They can be handy later on. Like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>LABEL</span> version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.1-beta&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> vendor<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rnemet.dev&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> release-date<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2024-02-12&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>You could also use <code>ARG</code> to set labels. Like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.0.1-beta<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> VENDOR<span style=color:#f92672>=</span>rnemet.dev<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> RELEASE_DATE<span style=color:#f92672>=</span><span style=color:#ae81ff>2024</span>-02-12<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.1-beta&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> vendor<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rnemet.dev&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> release-date<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2024-02-12&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>I hope you enjoyed this post and learned something new. If you found this helpful post, please share it with your friends. You can subscribe to my newsletter at the
bottom of this post and/or share this post. I would appreciate it.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://docs.docker.com/build/buildkit/>BuildKit</a></li><li><a href=https://www.linux.com/news/understanding-and-securing-linux-namespaces/>Linux namespaces</a></li><li><a href=https://docs.docker.com/engine/security/userns-remap/>Docker user namespaces</a></li><li><a href=https://hub.docker.com/_/scratch>Scratch image</a></li><li><a href=https://docs.docker.com/build/building/base-images/#create-a-simple-parent-image-using-scratch>Building image from scratch</a></li><li><a href=https://github.com/GoogleContainerTools/distroless>Distroless images</a></li><li><a href=https://github.com/wolfi-dev/>Wolfi</a></li><li><a href=https://hub.docker.com/_/alpine>Alpine Linux</a></li></ul><div class=subscribe><iframe src=https://rnemet.substack.com/embed width=480 height=320 style="border:1px solid #eee;background:#fff;margin:auto;display:block" frameborder=0 scrolling=no></iframe></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://rnemet.dev/tags/docker/>docker</a></li><li><a href=https://rnemet.dev/tags/kubernetes/>kubernetes</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes on x" href="https://x.com/intent/tweet/?text=Building%20Docker%20Images%20Smaller%2c%20Rootless%20and%20Non-Shell%20for%20Kubernetes&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fdocker%2fimage_k8s%2f&amp;hashtags=docker%2ckubernetes"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fdocker%2fimage_k8s%2f&amp;title=Building%20Docker%20Images%20Smaller%2c%20Rootless%20and%20Non-Shell%20for%20Kubernetes&amp;summary=Building%20Docker%20Images%20Smaller%2c%20Rootless%20and%20Non-Shell%20for%20Kubernetes&amp;source=https%3a%2f%2frnemet.dev%2fposts%2fdocker%2fimage_k8s%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frnemet.dev%2fposts%2fdocker%2fimage_k8s%2f&title=Building%20Docker%20Images%20Smaller%2c%20Rootless%20and%20Non-Shell%20for%20Kubernetes"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frnemet.dev%2fposts%2fdocker%2fimage_k8s%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes on whatsapp" href="https://api.whatsapp.com/send?text=Building%20Docker%20Images%20Smaller%2c%20Rootless%20and%20Non-Shell%20for%20Kubernetes%20-%20https%3a%2f%2frnemet.dev%2fposts%2fdocker%2fimage_k8s%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes on telegram" href="https://telegram.me/share/url?text=Building%20Docker%20Images%20Smaller%2c%20Rootless%20and%20Non-Shell%20for%20Kubernetes&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fdocker%2fimage_k8s%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Building Docker Images Smaller, Rootless and Non-Shell for Kubernetes on ycombinator" href="https://news.ycombinator.com/submitlink?t=Building%20Docker%20Images%20Smaller%2c%20Rootless%20and%20Non-Shell%20for%20Kubernetes&u=https%3a%2f%2frnemet.dev%2fposts%2fdocker%2fimage_k8s%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://rnemet.dev/>DevCube</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>