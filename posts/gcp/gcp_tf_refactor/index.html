<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>GCP With Terraform: Refactor with Modules | DevCube</title><meta name=keywords content="gcp,terraform,cloud,networking,vpc"><meta name=description content="This post is the fourth part of the series about using Terraform to manage GCP resources. In the first part, I did a basic setup of the project: remote state file, state file encryption, a bucket creation. In the second part, I created VPC and subnets and added some basic firewall rules and VMs. In the third part, I added more VPC, subnets, firewall rules, and VMs. In this part, I will refactor the project to make it more manageable."><meta name=author content="Robert Nemet"><link rel=canonical href=https://rnemet.dev/posts/gcp/gcp_tf_refactor/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://rnemet.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rnemet.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rnemet.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://rnemet.dev/apple-touch-icon.png><link rel=mask-icon href=https://rnemet.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-L148RQBR36"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-L148RQBR36",{anonymize_ip:!1})}</script><meta property="og:title" content="GCP With Terraform: Refactor with Modules"><meta property="og:description" content="This post is the fourth part of the series about using Terraform to manage GCP resources. In the first part, I did a basic setup of the project: remote state file, state file encryption, a bucket creation. In the second part, I created VPC and subnets and added some basic firewall rules and VMs. In the third part, I added more VPC, subnets, firewall rules, and VMs. In this part, I will refactor the project to make it more manageable."><meta property="og:type" content="article"><meta property="og:url" content="https://rnemet.dev/posts/gcp/gcp_tf_refactor/"><meta property="og:image" content="https://rnemet.dev/images/refactoring_tf.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-05T21:32:48+02:00"><meta property="article:modified_time" content="2023-09-05T21:32:48+02:00"><meta property="og:site_name" content="DevCube"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rnemet.dev/images/refactoring_tf.png"><meta name=twitter:title content="GCP With Terraform: Refactor with Modules"><meta name=twitter:description content="This post is the fourth part of the series about using Terraform to manage GCP resources. In the first part, I did a basic setup of the project: remote state file, state file encryption, a bucket creation. In the second part, I created VPC and subnets and added some basic firewall rules and VMs. In the third part, I added more VPC, subnets, firewall rules, and VMs. In this part, I will refactor the project to make it more manageable."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rnemet.dev/posts/"},{"@type":"ListItem","position":2,"name":"GCP With Terraform: Refactor with Modules","item":"https://rnemet.dev/posts/gcp/gcp_tf_refactor/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"GCP With Terraform: Refactor with Modules","name":"GCP With Terraform: Refactor with Modules","description":"This post is the fourth part of the series about using Terraform to manage GCP resources. In the first part, I did a basic setup of the project: remote state file, state file encryption, a bucket creation. In the second part, I created VPC and subnets and added some basic firewall rules and VMs. In the third part, I added more VPC, subnets, firewall rules, and VMs. In this part, I will refactor the project to make it more manageable.","keywords":["gcp","terraform","cloud","networking","vpc"],"articleBody":"This post is the fourth part of the series about using Terraform to manage GCP resources. In the first part, I did a basic setup of the project: remote state file, state file encryption, a bucket creation. In the second part, I created VPC and subnets and added some basic firewall rules and VMs. In the third part, I added more VPC, subnets, firewall rules, and VMs. In this part, I will refactor the project to make it more manageable. It should be more DRY and easier to maintain while supporting multiple environments.\nCurrent State You can look at the project’s current state here. The existing file structure is like this:\n├── README.md ├── Taskfile.yml └── gcp ├── base │ ├── .terraform-version │ ├── .terraform.lock.hcl │ ├── README.md │ ├── main.tf │ ├── outputs.tf │ ├── provider.tf │ ├── terraform.tfvars │ └── variables.tf ├── network │ ├── .terraform-version │ ├── .terraform.lock.hcl │ ├── README.md │ ├── main.tf │ ├── outputs.tf | ├── peering.tf │ ├── provider.tf │ ├── terraform.tfvars | ├── vpc_back_office.tf │ ├── vpc_datastorages.tf | ├── vpc_services.tf │ └── variables.tf └── vms ├── .terraform-version ├── .terraform.lock.hcl ├── README.md ├── main.tf ├── back_office.tf ├── imports.tf ├── outputs.tf ├── provider.tf ├── terraform.tfvars └── variables.tf The base directory contains the basic setup of the project. It creates a bucket for the remote state file, enabling the state file’s encryption. The network directory contains the VPC, subnets, and firewall rules. The vms directory contains the VMs. The Taskfile.yml is used to run the tasks. The README.md contains the documentation of the project.\nThere are several problems with this setup:\nModules network and vms handle more than they should. For example, the network module creates VPC, subnets, and firewall rules for all VPCs. It should handle only one VPC. This way, whenever I make a change in one VPC when I run terraform plan/apply in the module network other VPCs will be touched. If I have to work with others, this is the possible bottleneck. The vms module is creating VMs for all VPCs. There is a lot of code duplication. This structure does not support multiple environments. I can’t have a dev and prod environment with this setup. Changing one module requires running terraform plan/apply in all modules(not always). For example, when adding a service account to the VMs, I had to run terraform plan/apply in the network and vms modules. It is not a big deal, but it is annoying. Step one: Split into environments The first step is to split the project into environments. I will create two environments: dev and prod. I will create two directories: dev and prod on the project level. Then, I will copy whole gcp directory into both dev and prod directories.\n. ├── README.md ├── Taskfile.yml ├── dev │ ├── base │ ├── network │ └── vms └── prod ├── base ├── network └── vms Why? With this change, I’m reducing the impact of changes. While in an ideal case, these environments should be identical, they are not. To be honest, you do not need the same level of resources in dev and prod.\nStep two: Create a module for each VPC The network module is doing too much. It is creating VPC, subnets, and firewall rules for all VPCs. It will be much better if it makes only one VPC, subnets, and firewall rules for that VPC. But the same thing applies to the vms module. It is creating VMs for all VPCs. It will be much better if it makes VMs for only one VPC.\nIf I put network stuff and VMs in the same folder, which will then contain network and vms modules, for each VPC, I can create a VPC, subnets, firewall rules, and VMs for that VPC. This way, I’m separating the network stuff and VMs for each VPC. But, at the same time, I’m keeping them together. This way, I’m reducing the impact of changes. So, my new file structure looks like this:\n. ├── README.md ├── Taskfile.yml ├── dev │ ├── base │ ├── back-office │ │ ├── network │ │ └── vms │ ├── services │ │ ├── network │ │ └── vms │ └── storage │ ├── network │ └── vms └── prod ├── base ├── back-office │ ├── network │ └── vms ├── services │ ├── network │ └── vms └── storage ├── network └── vms In addition to this change, I’ll keep code related to the target VPC. This change simplifies the code, increases readability, and reduces the impact of changes. But at the same time, it increases the number of modules, and there is an increase in code duplication. Before dealing with code duplication, I’ll ensure the code is working and has the same structure.\nWhat does that mean? Each module will have the same structure: main.tf, outputs.tf, provider.tf, terraform.tfvars, and variables.tf. The main.tf will contain the code for creating resources. The outputs.tf will contain the outputs of the module. The provider.tf will contain the provider configuration. The terraform.tfvars will contain the variables for the module. The variables.tf will contain the variables for the module.\nRefactoring the base module This module is the most straightforward module to refactor. There is little to change. Except the where the state file is stored. It’s done by changing the backend.prefix in:\nterraform { required_version = \"\u003e=1.5.5\" required_providers { google = { source = \"hashicorp/google\" version = \"4.77.0\" } } backend \"gcs\" { bucket = \"terraform-states-network-playground-382512\" prefix = \"terraform/state/dev/base\" } } The state file for the base module will be in the terraform/state/dev/base directory. The previous state file was in the terraform/state/base. How do I move the state file? Manually? It can be done. But there is a better way. If I run the terraform plan in the base module, I will get the following output:\n$ terraform plan ╷ │ Error: Backend initialization required: please run \"terraform init\" │ │ Reason: Backend configuration block has changed │ │ The \"backend\" is the interface that Terraform uses to store state, │ perform operations, etc. If this message is showing up, it means that the │ Terraform configuration you're using is using a custom configuration for │ the Terraform backend. │ │ Changes to backend configurations require reinitialization. This allows │ Terraform to set up the new configuration, copy existing state, etc. Please run │ \"terraform init\" with either the \"-reconfigure\" or \"-migrate-state\" flags to │ use the current configuration. │ │ If the change reason above is incorrect, please verify your configuration │ hasn't changed and try again. At this point, no changes to your existing │ configuration or state have been made. As the output clearly says, I must run terraform init with either the -reconfigure or -migrate-state flags. I’ll use the -migrate-state flag. This flag will migrate the state file to the new location. So, I’ll run terraform init -migrate-state in the base module. The output will be:\n$ terraform init -migrate-state Initializing the backend... Backend configuration changed! Terraform has detected that the configuration specified for the backend has changed. Terraform will now check for existing state in the backends. Acquiring state lock. This may take a few moments... Acquiring state lock. This may take a few moments... Do you want to copy existing state to the new backend? Pre-existing state was found while migrating the previous \"gcs\" backend to the newly configured \"gcs\" backend. No existing state was found in the newly configured \"gcs\" backend. Do you want to copy this state to the new \"gcs\" backend? Enter \"yes\" to copy and \"no\" to start with an empty state. Enter a value: yes Successfully configured the backend \"gcs\"! Terraform will automatically use this backend unless the backend configuration changes. Initializing provider plugins... - Reusing previous version of hashicorp/google from the dependency lock file - Using previously-installed hashicorp/google v4.77.0 Terraform has been successfully initialized! You may now begin working with Terraform. Try running \"terraform plan\" to see any changes that are required for your infrastructure. All Terraform commands should now work. If you ever set or change modules or backend configuration for Terraform, rerun this command to reinitialize your working directory. If you forget, other commands will detect it and remind you to do so if necessary. Running terrafom plan should work, giving you no changes as output.\nWith this, the base is checked.\nRefactoring the network module The network module is a bit more complicated to refactor. Initially, it created VPCs, subnets, and firewall rules for all VPCs. Now, it will create VPC, subnets, and firewall rules for only one VPC. That means that I have to split changes for each VPC. This is the easy part. A simple copy-paste technique will do the trick. But what about the state file? Let’s look at the first VPC: back-office for the dev environment:\n... backend \"gcs\" { bucket = \"terraform-states-network-playground-382512\" prefix = \"terraform/state/dev/back-office/network\" } } The state file for the network module will be in the terraform/state/dev/network/back-office directory. The previous state file was in the terraform/state/network. I can repeat the same technique as I did for the base module. However, I plan to remove all code related to the other VPCs. When I remove code related to the other VPCs, the Terraform will say that it will delete resources related to other VPCs. Why? It is simple: the state file for the network module contains resources related to other VPCs. So, when I remove code related to other VPCs, Terraform will see that the state file includes resources related to other VPCs and try to delete them. I want something else. I want to keep the resources related to other VPCs. So before I clean up the code, I’ll move the state file with the -migrate-state flag. I’ll run terraform init -migrate-state in the dev/back-office/network module. The Terraform will migrate the state file. If you look into the bucket, you will see that the ole state file is copied to the terraform/state/dev/network/back-office directory:\n$ gsutil ls gs://terraform-states-network-playground-382512/terraform/state/network gs://terraform-states-network-playground-382512/terraform/state/network/default.tfstate So, the -migration-state flag does not delete the old state file but copies it to the new location. This makes life easier. After Terraform migrates the state file, I can clean up the code. I’ll remove all code related to other VPCs.\nThe VPC peering is one thing that is related to all VPCs, and I need to refactor all of them before I can deal with it. I’ll name a separate module in the dev environment peering. This module will contain the code for creating VPC peering for all VPCs. For now, it should be a copy of the old network module.\nTo continue with the refactoring back-office VPC, I’ll remove all code related to other VPCs. When I run terraform plan this time, I’ll get the following output as expected. I see that Terraform will delete resources related to other VPCs. I see the message Plan: 0 to add, 0 to change, 12 to destroy.So, I want to keep the resources related to other VPCs but to delete them from the state file related to the VPCback-officenetwork module. I can do that by running theterraform state rmcommand. I'll runterraform state rm` for each resource related to other VPCs. For example:\n$ terraform state rm google_compute_subnetwork.subnet_postgres Acquiring state lock. This may take a few moments... Removed google_compute_subnetwork.subnet_postgres Successfully removed 1 resource instance(s). So there is a lot of typing. You can use more than one resource when removing resources from the state file. I do this until I get the message that there is nothing to change. All of this I do for the other VPCs in the dev environment.\nTo refactor the dev/peerings module, I’ll do the same thing as I did for the dev/back-office/network module. I’ll migrate the state file and remove all code related to VPCs, except peerings. I have to import the VPC information for each VPC from their state files:\ndata \"terraform_remote_state\" \"back_office\" { backend = \"gcs\" config = { bucket = \"terraform-states-network-playground-382512\" prefix = \"terraform/state/dev/back-office/network\" } } data \"terraform_remote_state\" \"services\" { backend = \"gcs\" config = { bucket = \"terraform-states-network-playground-382512\" prefix = \"terraform/state/dev/services/network\" } } data \"terraform_remote_state\" \"storage\" { backend = \"gcs\" config = { bucket = \"terraform-states-network-playground-382512\" prefix = \"terraform/state/dev/storage/network\" } } Of course, those are exported in the outputs. tf file for each VPC:\noutput \"vpc_services\" { value = google_compute_network.services.self_link } output \"vpc_services_subnetwork\" { value = google_compute_subnetwork.services } Refactoring the vms module The vms module situation resembles the network module. The only difference is that I must import the VPC information from the network modules. So, first, I’ll migrate the state file, remove all code related to other VPCs, and then import the VPC information from the network module. I’ll do this for each VPC in the dev environment.\nSee the final code here.\nWhen done, inspect the code. Notice how much there is duplicate code or almost the same code. Ignore resource names and a number of resources. That means that I can reuse the code.\nStep three: Reuse the code with modules There are a lot of code that is duplicated or almost the same. I want to make my code DRY. I can do it either by using Google network module or writing my module. It is wiser to use the already existing Google network module.\nRefactoring the dev/back-office/network module to use the Google network module is straightforward:\nmodule \"back-office\" { source = \"terraform-google-modules/network/google\" version = \"~\u003e 7.3\" project_id = var.project_id network_name = \"back-office\" routing_mode = \"REGIONAL\" subnets = [ { subnet_name = \"back-office\" subnet_ip = \"10.1.0.0/24\" subnet_region = var.region }, { subnet_name = \"back-office-private\" subnet_ip = \"10.2.0.0/24\" subnet_region = var.region } ] ingress_rules = [ { name = \"back-office-icmp\" allow = [ { protocol = \"icmp\" } ] source_ranges = [ \"0.0.0.0/0\" ] }, { name = \"back-office-iap\" allow = [ { protocol = \"tcp\" } ] source_ranges = [ \"35.235.240.0/20\" ] target_service_accounts = [google_service_account.back_office_fw_sa.email] allow = [ { protocol = \"tcp\" } ] depends_on = [google_service_account.back_office_fw_sa] } ] } Notice that now I am not creating resources directly. Instead, I am calling the module and passing variables to it. That is the way to reuse code in Terraform.\nThis code is more readable, and it is easier to maintain. But, as in the previous step, working with the state file is tricky. This time, I’ll remove all other resources from the code. Since I have added the module, I need to run terraform init and then terraform plan. The plan will tell me that there are five resources to add and five to destroy. But I do not want to destroy anything. What I need to do is to rename the resources in the state file. I’ll do that by running the terraform state mv command. For example:\n$ terraform state mv google_compute_network.back_office module.back-office.module.vpc.google_compute_network.network Acquiring state lock. This may take a few moments... Move \"google_compute_network.back_office\" to \"module.back-office.module.vpc.google_compute_network.network\" Successfully moved 1 object(s). $ terraform state mv google_compute_subnetwork.back_office_private 'module.back-office.module.subnets.google_compute_subnetwork.subnetwork[\"us-central1/back-office-private\"]' Move \"google_compute_subnetwork.back_office_private\" to \"module.back-office.module.subnets.google_compute_subnetwork.subnetwork[\\\"us-central1/back-office-private\\\"]\" Successfully moved 1 object(s). $ terraform state mv google_compute_subnetwork.back_office 'module.back-office.module.subnets.google_compute_subnetwork.subnetwork[\"us-central1/back-office\"]' Move \"google_compute_subnetwork.back_office\" to \"module.back-office.module.subnets.google_compute_subnetwork.subnetwork[\\\"us-central1/back-office\\\"]\" Successfully moved 1 object(s). Releasing state lock. This may take a few moments... $ terraform state mv google_compute_firewall.back_office_icmp 'module.back-office.module.firewall_rules.google_compute_firewall.rules_ingress_egress[\"back-office-icmp\"]' Move \"google_compute_firewall.back_office_icmp\" to \"module.back-office.module.firewall_rules.google_compute_firewall.rules_ingress_egress[\\\"back-office-icmp\\\"]\" Successfully moved 1 object(s). Releasing state lock. This may take a few moments... $ terraform state mv google_compute_firewall.back_office_iap 'module.back-office.module.firewall_rules.google_compute_firewall.rules_ingress_egress[\"back-office-iap\"]' Move \"google_compute_firewall.back_office_iap\" to \"module.back-office.module.firewall_rules.google_compute_firewall.rules_ingress_egress[\\\"back-office-iap\\\"]\" Successfully moved 1 object(s). Releasing state lock. This may take a few moments... As well, I want to retain the same outputs, so I refactor the outputs.tf file:\noutput \"vpc_back_office\" { value = module.back-office.network_self_link } output \"vpc_back_office_id\" { value = module.back-office.network_id } output \"vpc_back_office_subnetwork\" { value = module.back-office.subnets[\"us-central1/back-office\"] } output \"vpc_back_office_private_subnetwork\" { value = module.back-office.subnets[\"us-central1/back-office-private\"] } output \"back_office_fw_sa\" { value = google_service_account.back_office_fw_sa.email } Now, I can run the terraform plan and see no changes. I can do the same for the other VPCs in the dev environment.\nIf you wonder how to know which resource to rename, you can run terraform plan and see which resources will be destroyed. Those are the resources that you need to rename. Names of new resources are new names of old resources.\nTerraform will not allow you to rename resources of different types. So, you can’t rename a subnet to a firewall rule. You can rename a subnet to a subnet and a firewall rule to a firewall rule.\nReuse code in the vms module In the previous step, I used the already provided module. But I can write my module, too. For managing VMs, I’ll do it. I’ll create the ’ vms’ module in the /modules/vms directory. It will have two files, main.tf and variables.tf. The main.tf will contain the code for creating VMs. The variables.tf will have the variables for the module. The main.tf will look like this:\nresource \"google_compute_instance\" \"virtual_machine\" { name = var.name machine_type = var.machine_type zone = var.zone scheduling { preemptible = true automatic_restart = false provisioning_model = \"SPOT\" instance_termination_action = \"STOP\" } allow_stopping_for_update = var.allow_stopping_for_update dynamic \"service_account\" { for_each = var.sa_email != \"\" ? [var.sa_email] : [] content { email = service_account.value scopes = [\"https://www.googleapis.com/auth/cloud-platform\"] } } boot_disk { initialize_params { image = \"debian-cloud/debian-11\" } } network_interface { network = var.network subnetwork = var.subnetwork } } In simple terms, look at how the code looks in each VPC for creating VMs. It is the same. You extract common code and put it in the module. All values that differ are replaced with variables. Terraform does not have a classic if-then-else statement, so you must use dynamic block. So, this is my VM template.\nWhen using it in the dev/services/vms module, it will look like this:\nmodule \"services_vm_test\" { source = \"../../../modules/vms\" zone = var.zone machine_type = \"f1-micro\" name = \"services-vm-test\" network = data.terraform_remote_state.vpc_services.outputs.vpc_services_id subnetwork = data.terraform_remote_state.vpc_services.outputs.vpc_services_subnetwork.id } I could even put machine_type as a fixed value in the module. But I want to have the flexibility to change it. So, I’ll leave it as a variable. For the dev/back-office/vms module, it will look like this:\nmodule \"vms\" { for_each = toset([\"back-office-vm2\", \"back-office-private-vm1\", \"back-office-private-vm2\", \"back-office-vm1\"]) source = \"../../../modules/vms\" zone = var.zone machine_type = \"f1-micro\" name = each.value network = data.terraform_remote_state.back_office.outputs.vpc_back_office_id subnetwork = data.terraform_remote_state.back_office.outputs.vpc_back_office_subnetwork.id sa_email = \"back-office-vm1\" == each.value ? data.terraform_remote_state.back_office.outputs.back_office_fw_sa : \"\" allow_stopping_for_update = \"back-office-vm1\" == each.value ? true : false } As the machine name differs for each VM, I’m using the for_each block. The only exception is back-office-vm1. For this VM, I’m using a service account that I created for firewall rules. That’s why I’m using the Elvis operator to check if the VM is back-office-vm1. If it is, I’m using a service account; otherwise, I’m using an empty string.\nReuse code in the peering module First, let’s see the code:\nlocals { peerings = { \"back-office-services-peering\" : { \"network\" : data.terraform_remote_state.back_office.outputs.vpc_back_office, \"peer_network\" : data.terraform_remote_state.services.outputs.vpc_services }, \"services-back-office-peering\" : { \"network\" : data.terraform_remote_state.services.outputs.vpc_services, \"peer_network\" : data.terraform_remote_state.back_office.outputs.vpc_back_office, }, \"back-office-storage-peering\" : { \"network\" : data.terraform_remote_state.back_office.outputs.vpc_back_office, \"peer_network\" : data.terraform_remote_state.storage.outputs.vpc_storage, }, \"storage-back-office-peering\" : { \"network\" : data.terraform_remote_state.storage.outputs.vpc_storage, \"peer_network\" : data.terraform_remote_state.back_office.outputs.vpc_back_office, } } } resource \"google_compute_network_peering\" \"peerings\" { for_each = local.peerings name = each.key network = each.value.network peer_network = each.value.peer_network } First, I define the locals block. It contains a map of maps. Each map contains information about peering. In this case, I can not use variables because when you assign value to a variable in the variable.tf file or terraform.tfvars file, you can not use other variables. So, I have to use the locals block. In the locals block, I define a map for peering. The key is the peering name, and the value is a map with two keys: network and peer_network. This setup allows me to use the for_each block in the google_compute_network_peering resource.\nThe final result is here.\nConclusion In this part, I refactored the project to make it more manageable: I split the project into environments, created a module for each VPC, and reused the code with modules. I used already existing modules, and I wrote my module. I used the terraform state mv command to move resources from one state file to another. I used the terraform state rm command to remove resources from the state file.\nIn the next part, let’s try to use Terragrunt to make our code even more DRY and make running CLI commands easier.\nEnjoy…\n","wordCount":"3362","inLanguage":"en","image":"https://rnemet.dev/images/refactoring_tf.png","datePublished":"2023-09-05T21:32:48+02:00","dateModified":"2023-09-05T21:32:48+02:00","author":{"@type":"Person","name":"Robert Nemet"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rnemet.dev/posts/gcp/gcp_tf_refactor/"},"publisher":{"@type":"Organization","name":"DevCube","logo":{"@type":"ImageObject","url":"https://rnemet.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rnemet.dev/ accesskey=h title="Home (Alt + H)"><img src=https://rnemet.dev/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rnemet.dev/posts/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://rnemet.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://rnemet.dev/posts/practical_k8s/ title="Practical k8s"><span>Practical k8s</span></a></li><li><a href=https://rnemet.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://rnemet.dev/about/ title="About Me"><span>About Me</span></a></li><li><a href=https://rnemet.dev/ title><span></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>GCP With Terraform: Refactor with Modules</h1><div class=post-description></div><div class=post-meta><span title='2023-09-05 21:32:48 +0200 CEST'>September 5, 2023</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;Robert Nemet</div></header><figure class=entry-cover><img loading=lazy src=https://rnemet.dev/images/refactoring_tf.png alt><p></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#current-state aria-label="Current State">Current State</a></li><li><a href=#step-one-split-into-environments aria-label="Step one: Split into environments">Step one: Split into environments</a></li><li><a href=#step-two-create-a-module-for-each-vpc aria-label="Step two: Create a module for each VPC">Step two: Create a module for each VPC</a><ul><li><a href=#refactoring-the-base-module aria-label="Refactoring the base module">Refactoring the base module</a></li><li><a href=#refactoring-the-network-module aria-label="Refactoring the network module">Refactoring the network module</a></li><li><a href=#refactoring-the-vms-module aria-label="Refactoring the vms module">Refactoring the vms module</a></li></ul></li><li><a href=#step-three-reuse-the-code-with-modules aria-label="Step three: Reuse the code with modules">Step three: Reuse the code with modules</a><ul><li><a href=#reuse-code-in-the-vms-module aria-label="Reuse code in the vms module">Reuse code in the vms module</a></li><li><a href=#reuse-code-in-the-peering-module aria-label="Reuse code in the peering module">Reuse code in the peering module</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>This post is the fourth part of the series about using Terraform to manage GCP resources. In the <a href=/posts/gcp/start_with_gcp/>first part</a>, I did a basic setup of the project:
remote state file, state file encryption, a bucket creation. In the <a href=/gcp/gcp-tf-vpc/>second part</a>, I created VPC and subnets and added some basic firewall rules
and VMs. In the <a href=/gcp/gcp-tf-vpc-firewall_2/>third part</a>, I added more VPC, subnets, firewall rules, and VMs. In this part, I will refactor the project to make it more
manageable. It should be more DRY and easier to maintain while supporting multiple environments.</p><h2 id=current-state>Current State<a hidden class=anchor aria-hidden=true href=#current-state>#</a></h2><p>You can look at the project&rsquo;s current state <a href=https://github.com/robert-nemet/pcne/tree/start_refactoring>here</a>. The existing file structure is like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>├── Taskfile.yml
</span></span><span style=display:flex><span>└── gcp
</span></span><span style=display:flex><span>    ├── base
</span></span><span style=display:flex><span>    │   ├── .terraform-version
</span></span><span style=display:flex><span>    │   ├── .terraform.lock.hcl
</span></span><span style=display:flex><span>    │   ├── README.md
</span></span><span style=display:flex><span>    │   ├── main.tf
</span></span><span style=display:flex><span>    │   ├── outputs.tf
</span></span><span style=display:flex><span>    │   ├── provider.tf
</span></span><span style=display:flex><span>    │   ├── terraform.tfvars
</span></span><span style=display:flex><span>    │   └── variables.tf
</span></span><span style=display:flex><span>    ├── network
</span></span><span style=display:flex><span>    │   ├── .terraform-version
</span></span><span style=display:flex><span>    │   ├── .terraform.lock.hcl
</span></span><span style=display:flex><span>    │   ├── README.md
</span></span><span style=display:flex><span>    │   ├── main.tf
</span></span><span style=display:flex><span>    │   ├── outputs.tf
</span></span><span style=display:flex><span>    |   ├── peering.tf
</span></span><span style=display:flex><span>    │   ├── provider.tf
</span></span><span style=display:flex><span>    │   ├── terraform.tfvars
</span></span><span style=display:flex><span>    |   ├── vpc_back_office.tf
</span></span><span style=display:flex><span>    │   ├── vpc_datastorages.tf
</span></span><span style=display:flex><span>    |   ├── vpc_services.tf
</span></span><span style=display:flex><span>    │   └── variables.tf
</span></span><span style=display:flex><span>    └── vms
</span></span><span style=display:flex><span>        ├── .terraform-version
</span></span><span style=display:flex><span>        ├── .terraform.lock.hcl
</span></span><span style=display:flex><span>        ├── README.md
</span></span><span style=display:flex><span>        ├── main.tf
</span></span><span style=display:flex><span>        ├── back_office.tf
</span></span><span style=display:flex><span>        ├── imports.tf
</span></span><span style=display:flex><span>        ├── outputs.tf
</span></span><span style=display:flex><span>        ├── provider.tf
</span></span><span style=display:flex><span>        ├── terraform.tfvars
</span></span><span style=display:flex><span>        └── variables.tf
</span></span></code></pre></div><p>The <code>base</code> directory contains the basic setup of the project. It creates a bucket for the remote state file, enabling the state file&rsquo;s encryption. The <code>network</code>
directory contains the VPC, subnets, and firewall rules. The <code>vms</code> directory contains the VMs. The <code>Taskfile.yml</code> is used to run the tasks. The <code>README.md</code> contains the
documentation of the project.</p><p>There are several problems with this setup:</p><ul><li>Modules <code>network</code> and <code>vms</code> handle more than they should. For example, the <code>network</code> module creates VPC, subnets, and firewall rules for all VPCs.
It should handle only one VPC. This way, whenever I make a change in one VPC when I run <code>terraform plan/apply</code> in the module <code>network</code> other VPCs will be touched. If I have
to work with others, this is the possible bottleneck. The <code>vms</code> module is creating VMs for all VPCs.</li><li>There is a lot of code duplication.</li><li>This structure does not support multiple environments. I can&rsquo;t have a dev and prod environment with this setup.</li><li>Changing one module requires running <code>terraform plan/apply</code> in all modules(not always). For example, when adding a service account to the VMs, I had to
run <code>terraform plan/apply</code> in the <code>network</code> and <code>vms</code> modules. It is not a big deal, but it is annoying.</li></ul><h2 id=step-one-split-into-environments>Step one: Split into environments<a hidden class=anchor aria-hidden=true href=#step-one-split-into-environments>#</a></h2><p>The first step is to split the project into environments. I will create two environments: <code>dev</code> and <code>prod</code>. I will create two directories: <code>dev</code> and <code>prod</code> on the project
level. Then, I will copy whole <code>gcp</code> directory into both <code>dev</code> and <code>prod</code> directories.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>├── Taskfile.yml
</span></span><span style=display:flex><span>├── dev
</span></span><span style=display:flex><span>│   ├── base
</span></span><span style=display:flex><span>│   ├── network
</span></span><span style=display:flex><span>│   └── vms
</span></span><span style=display:flex><span>└── prod
</span></span><span style=display:flex><span>    ├── base
</span></span><span style=display:flex><span>    ├── network
</span></span><span style=display:flex><span>    └── vms
</span></span></code></pre></div><p>Why? With this change, I&rsquo;m reducing the impact of changes. While in an ideal case, these environments should be identical, they are not. To be honest, you
do not need the same level of resources in dev and prod.</p><h2 id=step-two-create-a-module-for-each-vpc>Step two: Create a module for each VPC<a hidden class=anchor aria-hidden=true href=#step-two-create-a-module-for-each-vpc>#</a></h2><p>The <code>network</code> module is doing too much. It is creating VPC, subnets, and firewall rules for all VPCs. It will be much better if it makes only one VPC, subnets, and
firewall rules for that VPC. But the same thing applies to the <code>vms</code> module. It is creating VMs for all VPCs. It will be much better if it makes VMs for only one VPC.</p><p>If I put network stuff and VMs in the same folder, which will then contain <code>network</code> and <code>vms</code> modules, for each VPC, I can create a VPC, subnets, firewall
rules, and VMs for that VPC. This way, I&rsquo;m separating the network stuff and VMs for each VPC. But, at the same time, I&rsquo;m keeping them together. This way, I&rsquo;m reducing
the impact of changes. So, my new file structure looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>├── Taskfile.yml
</span></span><span style=display:flex><span>├── dev
</span></span><span style=display:flex><span>│   ├── base
</span></span><span style=display:flex><span>│   ├── back-office
</span></span><span style=display:flex><span>│   │   ├── network
</span></span><span style=display:flex><span>│   │   └── vms
</span></span><span style=display:flex><span>│   ├── services
</span></span><span style=display:flex><span>│   │   ├── network
</span></span><span style=display:flex><span>│   │   └── vms
</span></span><span style=display:flex><span>│   └── storage
</span></span><span style=display:flex><span>│       ├── network
</span></span><span style=display:flex><span>│       └── vms
</span></span><span style=display:flex><span>└── prod
</span></span><span style=display:flex><span>    ├── base
</span></span><span style=display:flex><span>    ├── back-office
</span></span><span style=display:flex><span>    │   ├── network
</span></span><span style=display:flex><span>    │   └── vms
</span></span><span style=display:flex><span>    ├── services
</span></span><span style=display:flex><span>    │   ├── network
</span></span><span style=display:flex><span>    │   └── vms
</span></span><span style=display:flex><span>    └── storage
</span></span><span style=display:flex><span>        ├── network
</span></span><span style=display:flex><span>        └── vms
</span></span></code></pre></div><p>In addition to this change, I&rsquo;ll keep code related to the target VPC. This change simplifies the code, increases readability, and reduces the impact of changes. But at the
same time, it increases the number of modules, and there is an increase in code duplication. Before dealing with code duplication, I&rsquo;ll ensure the code is working
and has the same structure.</p><p>What does that mean? Each module will have the same structure: <code>main.tf</code>, <code>outputs.tf</code>, <code>provider.tf</code>, <code>terraform.tfvars</code>, and <code>variables.tf</code>. The <code>main.tf</code> will
contain the code for creating resources. The <code>outputs.tf</code> will contain the outputs of the module. The <code>provider.tf</code> will contain the provider configuration. The
<code>terraform.tfvars</code> will contain the variables for the module. The <code>variables.tf</code> will contain the variables for the module.</p><h3 id=refactoring-the-base-module>Refactoring the base module<a hidden class=anchor aria-hidden=true href=#refactoring-the-base-module>#</a></h3><p>This module is the most straightforward module to refactor. There is little to change. Except the where the state file is stored. It&rsquo;s done by changing the <code>backend.prefix</code> in:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>terraform</span> {
</span></span><span style=display:flex><span>  required_version <span style=color:#f92672>=</span> &#34;&gt;<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>5</span>.<span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>required_providers</span> {
</span></span><span style=display:flex><span>    google <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hashicorp/google&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;4.77.0&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>backend</span> <span style=color:#e6db74>&#34;gcs&#34;</span> {
</span></span><span style=display:flex><span>    bucket <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-states-network-playground-382512&#34;</span>
</span></span><span style=display:flex><span>    prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform/state/dev/base&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The state file for the <code>base</code> module will be in the <code>terraform/state/dev/base</code> directory. The previous state file was in the <code>terraform/state/base</code>.
How do I move the state file? Manually? It can be done. But there is a better way. If I run the <code>terraform plan</code> in the <code>base</code> module, I will get the following output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform plan
</span></span><span style=display:flex><span>╷
</span></span><span style=display:flex><span>│ Error: Backend initialization required: please run <span style=color:#e6db74>&#34;terraform init&#34;</span>
</span></span><span style=display:flex><span>│
</span></span><span style=display:flex><span>│ Reason: Backend configuration block has changed
</span></span><span style=display:flex><span>│
</span></span><span style=display:flex><span>│ The <span style=color:#e6db74>&#34;backend&#34;</span> is the interface that Terraform uses to store state,
</span></span><span style=display:flex><span>│ perform operations, etc. If this message is showing up, it means that the
</span></span><span style=display:flex><span>│ Terraform configuration you<span style=color:#e6db74>&#39;re using is using a custom configuration for
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│ the Terraform backend.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│ Changes to backend configurations require reinitialization. This allows
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│ Terraform to set up the new configuration, copy existing state, etc. Please run
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│ &#34;terraform init&#34; with either the &#34;-reconfigure&#34; or &#34;-migrate-state&#34; flags to
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│ use the current configuration.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│ If the change reason above is incorrect, please verify your configuration
</span></span></span><span style=display:flex><span><span style=color:#e6db74>│ hasn&#39;</span>t changed and try again. At this point, no changes to your existing
</span></span><span style=display:flex><span>│ configuration or state have been made.
</span></span></code></pre></div><p>As the output clearly says, I must run <code>terraform init</code> with either the <code>-reconfigure</code> or <code>-migrate-state</code> flags. I&rsquo;ll use the <code>-migrate-state</code> flag. This flag will
migrate the state file to the new location. So, I&rsquo;ll run <code>terraform init -migrate-state</code> in the <code>base</code> module. The output will be:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform init -migrate-state
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Initializing the backend...
</span></span><span style=display:flex><span>Backend configuration changed!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform has detected that the configuration specified <span style=color:#66d9ef>for</span> the backend
</span></span><span style=display:flex><span>has changed. Terraform will now check <span style=color:#66d9ef>for</span> existing state in the backends.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Acquiring state lock. This may take a few moments...
</span></span><span style=display:flex><span>Acquiring state lock. This may take a few moments...
</span></span><span style=display:flex><span>Do you want to copy existing state to the new backend?
</span></span><span style=display:flex><span>  Pre-existing state was found <span style=color:#66d9ef>while</span> migrating the previous <span style=color:#e6db74>&#34;gcs&#34;</span> backend to the
</span></span><span style=display:flex><span>  newly configured <span style=color:#e6db74>&#34;gcs&#34;</span> backend. No existing state was found in the newly
</span></span><span style=display:flex><span>  configured <span style=color:#e6db74>&#34;gcs&#34;</span> backend. Do you want to copy this state to the new <span style=color:#e6db74>&#34;gcs&#34;</span>
</span></span><span style=display:flex><span>  backend? Enter <span style=color:#e6db74>&#34;yes&#34;</span> to copy and <span style=color:#e6db74>&#34;no&#34;</span> to start with an empty state.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Enter a value: yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Successfully configured the backend <span style=color:#e6db74>&#34;gcs&#34;</span>! Terraform will automatically
</span></span><span style=display:flex><span>use this backend unless the backend configuration changes.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Initializing provider plugins...
</span></span><span style=display:flex><span>- Reusing previous version of hashicorp/google from the dependency lock file
</span></span><span style=display:flex><span>- Using previously-installed hashicorp/google v4.77.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform has been successfully initialized!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You may now begin working with Terraform. Try running <span style=color:#e6db74>&#34;terraform plan&#34;</span> to see
</span></span><span style=display:flex><span>any changes that are required <span style=color:#66d9ef>for</span> your infrastructure. All Terraform commands
</span></span><span style=display:flex><span>should now work.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you ever set or change modules or backend configuration <span style=color:#66d9ef>for</span> Terraform,
</span></span><span style=display:flex><span>rerun this command to reinitialize your working directory. If you forget, other
</span></span><span style=display:flex><span>commands will detect it and remind you to <span style=color:#66d9ef>do</span> so <span style=color:#66d9ef>if</span> necessary.
</span></span></code></pre></div><p>Running <code>terrafom plan</code> should work, giving you <strong>no changes</strong> as output.</p><p>With this, the base is checked.</p><h3 id=refactoring-the-network-module>Refactoring the network module<a hidden class=anchor aria-hidden=true href=#refactoring-the-network-module>#</a></h3><p>The <code>network</code> module is a bit more complicated to refactor. Initially, it created VPCs, subnets, and firewall rules for all VPCs. Now, it will
create VPC, subnets, and firewall rules for only one VPC. That means that I have to split changes for each VPC. This is the easy part. A simple
copy-paste technique will do the trick. But what about the state file? Let&rsquo;s look at the first VPC: <code>back-office</code> for the <code>dev</code> environment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>backend</span> <span style=color:#e6db74>&#34;gcs&#34;</span> {
</span></span><span style=display:flex><span>    bucket <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-states-network-playground-382512&#34;</span>
</span></span><span style=display:flex><span>    prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform/state/dev/back-office/network&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The state file for the <code>network</code> module will be in the <code>terraform/state/dev/network/back-office</code> directory. The previous state file was in the <code>terraform/state/network</code>.
I can repeat the same technique as I did for the <code>base</code> module. However, I plan to remove all code related to the other VPCs. When I remove code related to the other VPCs, the Terraform
will say that it will delete resources related to other VPCs. Why? It is simple: the state file for the <code>network</code> module contains resources related to other VPCs. So, when I remove code
related to other VPCs, Terraform will see that the state file includes resources related to other VPCs and try to delete them. I want something else. I want to keep the resources
related to other VPCs. So before I clean up the code, I&rsquo;ll move the state file with the <code>-migrate-state</code> flag. I&rsquo;ll run <code>terraform init -migrate-state</code> in the <code>dev/back-office/network</code> module.
The Terraform will migrate the state file. If you look into the bucket, you will see that the ole state file is copied to the <code>terraform/state/dev/network/back-office</code> directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gsutil ls gs://terraform-states-network-playground-382512/terraform/state/network
</span></span><span style=display:flex><span>gs://terraform-states-network-playground-382512/terraform/state/network/default.tfstate
</span></span></code></pre></div><p>So, the <code>-migration-state</code> flag does not delete the old state file but copies it to the new location. This makes life easier. After Terraform migrates the state file, I can clean up the code. I&rsquo;ll
remove all code related to other VPCs.</p><p>The VPC peering is one thing that is related to all VPCs, and I need to refactor all of them before I can deal with it. I&rsquo;ll name a separate module in the dev environment
<code>peering</code>. This module will contain the code for creating VPC peering for all VPCs. For now, it should be a copy of the old <code>network</code> module.</p><p>To continue with the refactoring <code>back-office</code> VPC, I&rsquo;ll remove all code related to other VPCs. When I run <code>terraform plan</code> this time, I&rsquo;ll get the following output as expected. I see that
Terraform will delete resources related to other VPCs. I see the message <code>Plan:</code> 0 to add, 0 to change, 12 to destroy.<code>So, I want to keep the resources related to other VPCs but to delete them from the state file related to the VPC</code>back-office<code>network module. I can do that by running the</code>terraform state rm<code>command. I'll run</code>terraform state rm` for each resource related to other
VPCs. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform state rm google_compute_subnetwork.subnet_postgres
</span></span><span style=display:flex><span>Acquiring state lock. This may take a few moments...
</span></span><span style=display:flex><span>Removed google_compute_subnetwork.subnet_postgres
</span></span><span style=display:flex><span>Successfully removed <span style=color:#ae81ff>1</span> resource instance<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>.
</span></span></code></pre></div><p>So there is a lot of typing. You can use more than one resource when removing resources from the state file. I do this until I get the message that there is nothing to change. All of this I do for
the other VPCs in the dev environment.</p><p>To refactor the <code>dev/peerings</code> module, I&rsquo;ll do the same thing as I did for the <code>dev/back-office/network</code> module. I&rsquo;ll migrate the state file and remove all code related to VPCs, except
peerings. I have to import the VPC information for each VPC from their state files:</p><pre tabindex=0><code class=language-hcl: data-lang=hcl:>data &#34;terraform_remote_state&#34; &#34;back_office&#34; {
  backend = &#34;gcs&#34;

  config = {
    bucket = &#34;terraform-states-network-playground-382512&#34;
    prefix = &#34;terraform/state/dev/back-office/network&#34;
  }
}

data &#34;terraform_remote_state&#34; &#34;services&#34; {
  backend = &#34;gcs&#34;

  config = {
    bucket = &#34;terraform-states-network-playground-382512&#34;
    prefix = &#34;terraform/state/dev/services/network&#34;
  }
}

data &#34;terraform_remote_state&#34; &#34;storage&#34; {
  backend = &#34;gcs&#34;

  config = {
    bucket = &#34;terraform-states-network-playground-382512&#34;
    prefix = &#34;terraform/state/dev/storage/network&#34;
  }
}
</code></pre><p>Of course, those are exported in the <code>outputs. tf</code> file for each VPC:</p><pre tabindex=0><code class=language-hcl: data-lang=hcl:>output &#34;vpc_services&#34; {
  value = google_compute_network.services.self_link
}

output &#34;vpc_services_subnetwork&#34; {
  value = google_compute_subnetwork.services
}
</code></pre><h3 id=refactoring-the-vms-module>Refactoring the vms module<a hidden class=anchor aria-hidden=true href=#refactoring-the-vms-module>#</a></h3><p>The <code>vms</code> module situation resembles the <code>network</code> module. The only difference is that I must import the VPC information from the <code>network</code> modules. So, first, I&rsquo;ll migrate
the state file, remove all code related to other VPCs, and then import the VPC information from the <code>network</code> module. I&rsquo;ll do this for each VPC in the dev environment.</p><p>See the final code <a href=https://github.com/robert-nemet/pcne/tree/split_enviroments_vpcs>here</a>.</p><p>When done, inspect the code. Notice how much there is duplicate code or almost the same code. Ignore resource names and a number of resources. That means that I can reuse the code.</p><h2 id=step-three-reuse-the-code-with-modules>Step three: Reuse the code with modules<a hidden class=anchor aria-hidden=true href=#step-three-reuse-the-code-with-modules>#</a></h2><p>There are a lot of code that is duplicated or almost the same. I want to make my code DRY. I can do it either by using <a href=https://registry.terraform.io/modules/terraform-google-modules/network/google/latest>Google <code>network</code> module</a>
or writing my module. It is wiser to use the already existing <a href=https://registry.terraform.io/modules/terraform-google-modules/network/google/latest>Google <code>network</code> module</a>.</p><p>Refactoring the <code>dev/back-office/network</code> module to use the <a href=https://registry.terraform.io/modules/terraform-google-modules/network/google/latest>Google <code>network</code> module</a> is straightforward:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;back-office&#34;</span> {
</span></span><span style=display:flex><span>  source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-google-modules/network/google&#34;</span>
</span></span><span style=display:flex><span>  version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;~&gt; 7.3&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  project_id   <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>project_id</span>
</span></span><span style=display:flex><span>  network_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office&#34;</span>
</span></span><span style=display:flex><span>  routing_mode <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;REGIONAL&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  subnets <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      subnet_name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office&#34;</span>
</span></span><span style=display:flex><span>      subnet_ip     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.1.0.0/24&#34;</span>
</span></span><span style=display:flex><span>      subnet_region <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>region</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      subnet_name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office-private&#34;</span>
</span></span><span style=display:flex><span>      subnet_ip     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.2.0.0/24&#34;</span>
</span></span><span style=display:flex><span>      subnet_region <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>region</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ingress_rules <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office-icmp&#34;</span>
</span></span><span style=display:flex><span>      allow <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          protocol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;icmp&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>      source_ranges <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office-iap&#34;</span>
</span></span><span style=display:flex><span>      allow <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          protocol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>      source_ranges <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;35.235.240.0/20&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>      target_service_accounts <span style=color:#f92672>=</span> [<span style=color:#66d9ef>google_service_account</span>.<span style=color:#66d9ef>back_office_fw_sa</span>.<span style=color:#66d9ef>email</span>]
</span></span><span style=display:flex><span>      allow <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          protocol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>google_service_account</span>.<span style=color:#66d9ef>back_office_fw_sa</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Notice that now I am not creating resources directly. Instead, I am calling the module and passing variables to it. That is the way to reuse code in Terraform.</p><p>This code is more readable, and it is easier to maintain. But, as in the previous step, working with the state file is tricky. This time, I&rsquo;ll remove all other resources from the code. Since I have
added the module, I need to run <code>terraform init</code> and then <code>terraform plan</code>. The plan will tell me that there are five resources to add and five to destroy. But I do not want to destroy anything.
What I need to do is to rename the resources in the state file. I&rsquo;ll do that by running the <code>terraform state mv</code> command. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform state mv google_compute_network.back_office  module.back-office.module.vpc.google_compute_network.network
</span></span><span style=display:flex><span>Acquiring state lock. This may take a few moments...
</span></span><span style=display:flex><span>Move <span style=color:#e6db74>&#34;google_compute_network.back_office&#34;</span> to <span style=color:#e6db74>&#34;module.back-office.module.vpc.google_compute_network.network&#34;</span>
</span></span><span style=display:flex><span>Successfully moved <span style=color:#ae81ff>1</span> object<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ terraform state mv google_compute_subnetwork.back_office_private <span style=color:#e6db74>&#39;module.back-office.module.subnets.google_compute_subnetwork.subnetwork[&#34;us-central1/back-office-private&#34;]&#39;</span>
</span></span><span style=display:flex><span>Move <span style=color:#e6db74>&#34;google_compute_subnetwork.back_office_private&#34;</span> to <span style=color:#e6db74>&#34;module.back-office.module.subnets.google_compute_subnetwork.subnetwork[\&#34;us-central1/back-office-private\&#34;]&#34;</span>
</span></span><span style=display:flex><span>Successfully moved <span style=color:#ae81ff>1</span> object<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ terraform state mv google_compute_subnetwork.back_office <span style=color:#e6db74>&#39;module.back-office.module.subnets.google_compute_subnetwork.subnetwork[&#34;us-central1/back-office&#34;]&#39;</span>
</span></span><span style=display:flex><span>Move <span style=color:#e6db74>&#34;google_compute_subnetwork.back_office&#34;</span> to <span style=color:#e6db74>&#34;module.back-office.module.subnets.google_compute_subnetwork.subnetwork[\&#34;us-central1/back-office\&#34;]&#34;</span>
</span></span><span style=display:flex><span>Successfully moved <span style=color:#ae81ff>1</span> object<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>Releasing state lock. This may take a few moments...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ terraform state mv google_compute_firewall.back_office_icmp <span style=color:#e6db74>&#39;module.back-office.module.firewall_rules.google_compute_firewall.rules_ingress_egress[&#34;back-office-icmp&#34;]&#39;</span>
</span></span><span style=display:flex><span>Move <span style=color:#e6db74>&#34;google_compute_firewall.back_office_icmp&#34;</span> to <span style=color:#e6db74>&#34;module.back-office.module.firewall_rules.google_compute_firewall.rules_ingress_egress[\&#34;back-office-icmp\&#34;]&#34;</span>
</span></span><span style=display:flex><span>Successfully moved <span style=color:#ae81ff>1</span> object<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>Releasing state lock. This may take a few moments...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ terraform state mv google_compute_firewall.back_office_iap <span style=color:#e6db74>&#39;module.back-office.module.firewall_rules.google_compute_firewall.rules_ingress_egress[&#34;back-office-iap&#34;]&#39;</span>
</span></span><span style=display:flex><span>Move <span style=color:#e6db74>&#34;google_compute_firewall.back_office_iap&#34;</span> to <span style=color:#e6db74>&#34;module.back-office.module.firewall_rules.google_compute_firewall.rules_ingress_egress[\&#34;back-office-iap\&#34;]&#34;</span>
</span></span><span style=display:flex><span>Successfully moved <span style=color:#ae81ff>1</span> object<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>Releasing state lock. This may take a few moments...
</span></span></code></pre></div><p>As well, I want to retain the same outputs, so I refactor the <code>outputs.tf</code> file:</p><pre tabindex=0><code class=language-hcl: data-lang=hcl:>output &#34;vpc_back_office&#34; {
  value = module.back-office.network_self_link
}

output &#34;vpc_back_office_id&#34; {
  value = module.back-office.network_id
}

output &#34;vpc_back_office_subnetwork&#34; {
  value = module.back-office.subnets[&#34;us-central1/back-office&#34;]
}

output &#34;vpc_back_office_private_subnetwork&#34; {
  value = module.back-office.subnets[&#34;us-central1/back-office-private&#34;]
}

output &#34;back_office_fw_sa&#34; {
  value = google_service_account.back_office_fw_sa.email
}
</code></pre><p>Now, I can run the <code>terraform plan</code> and see no changes. I can do the same for the other VPCs in the dev environment.</p><p>If you wonder how to know which resource to rename, you can run <code>terraform plan</code> and see which resources will be destroyed. Those are the resources that you need to rename. Names of new resources
are new names of old resources.</p><p>Terraform will not allow you to rename resources of different types. So, you can&rsquo;t rename a subnet to a firewall rule. You can rename a subnet to a subnet and a firewall rule to a firewall rule.</p><h3 id=reuse-code-in-the-vms-module>Reuse code in the vms module<a hidden class=anchor aria-hidden=true href=#reuse-code-in-the-vms-module>#</a></h3><p>In the previous step, I used the already provided module. But I can write my module, too. For managing VMs, I&rsquo;ll do it. I&rsquo;ll create the &rsquo; vms&rsquo; module in the <code>&lt;project root>/modules/vms</code> directory.
It will have two files, <code>main.tf</code> and <code>variables.tf</code>. The <code>main.tf</code> will contain the code for creating VMs. The <code>variables.tf</code> will have the variables for the module. The <code>main.tf</code> will look like
this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_instance&#34; &#34;virtual_machine&#34;</span> {
</span></span><span style=display:flex><span>  name         <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  machine_type <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>machine_type</span>
</span></span><span style=display:flex><span>  zone         <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>zone</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>scheduling</span> {
</span></span><span style=display:flex><span>    preemptible                 <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    automatic_restart           <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    provisioning_model          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SPOT&#34;</span>
</span></span><span style=display:flex><span>    instance_termination_action <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;STOP&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  allow_stopping_for_update <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>allow_stopping_for_update</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>dynamic</span> <span style=color:#e6db74>&#34;service_account&#34;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    for_each <span style=color:#f92672>=</span> var.sa_email !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#960050;background-color:#1e0010>?</span> [<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>sa_email</span>] <span style=color:#960050;background-color:#1e0010>:</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>content</span> {
</span></span><span style=display:flex><span>      email  <span style=color:#f92672>=</span> <span style=color:#66d9ef>service_account</span>.<span style=color:#66d9ef>value</span>
</span></span><span style=display:flex><span>      scopes <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;https://www.googleapis.com/auth/cloud-platform&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boot_disk</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>initialize_params</span> {
</span></span><span style=display:flex><span>      image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;debian-cloud/debian-11&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>network_interface</span> {
</span></span><span style=display:flex><span>    network    <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>network</span>
</span></span><span style=display:flex><span>    subnetwork <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>subnetwork</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In simple terms, look at how the code looks in each VPC for creating VMs. It is the same. You extract common code and put it in the module. All values that differ are replaced with variables.
Terraform does not have a classic <code>if-then-else</code> statement, so you must use <a href=https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks><code>dynamic</code> block</a>. So, this is my VM
template.</p><p>When using it in the <code>dev/services/vms</code> module, it will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;services_vm_test&#34;</span> {
</span></span><span style=display:flex><span>  source       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../../../modules/vms&#34;</span>
</span></span><span style=display:flex><span>  zone         <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>zone</span>
</span></span><span style=display:flex><span>  machine_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;f1-micro&#34;</span>
</span></span><span style=display:flex><span>  name         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;services-vm-test&#34;</span>
</span></span><span style=display:flex><span>  network      <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>vpc_services</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_services_id</span>
</span></span><span style=display:flex><span>  subnetwork   <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>vpc_services</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_services_subnetwork</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I could even put <code>machine_type</code> as a fixed value in the module. But I want to have the flexibility to change it. So, I&rsquo;ll leave it as a variable. For the <code>dev/back-office/vms</code> module, it will look
like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;vms&#34;</span> {
</span></span><span style=display:flex><span>  for_each <span style=color:#f92672>=</span> <span style=color:#66d9ef>toset</span>([<span style=color:#e6db74>&#34;back-office-vm2&#34;, &#34;back-office-private-vm1&#34;, &#34;back-office-private-vm2&#34;, &#34;back-office-vm1&#34;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  source       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../../../modules/vms&#34;</span>
</span></span><span style=display:flex><span>  zone         <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>zone</span>
</span></span><span style=display:flex><span>  machine_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;f1-micro&#34;</span>
</span></span><span style=display:flex><span>  name         <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>
</span></span><span style=display:flex><span>  network      <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_back_office_id</span>
</span></span><span style=display:flex><span>  subnetwork   <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_back_office_subnetwork</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  sa_email                  <span style=color:#f92672>=</span> &#34;back-office-vm1&#34; <span style=color:#f92672>==</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span> <span style=color:#960050;background-color:#1e0010>?</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>back_office_fw_sa</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  allow_stopping_for_update <span style=color:#f92672>=</span> &#34;back-office-vm1&#34; <span style=color:#f92672>==</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span> <span style=color:#960050;background-color:#1e0010>?</span> <span style=color:#66d9ef>true</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As the machine name differs for each VM, I&rsquo;m using the <code>for_each</code> block. The only exception is <code>back-office-vm1</code>. For this VM, I&rsquo;m using a service account that I created for firewall rules. That&rsquo;s
why I&rsquo;m using the Elvis operator to check if the VM is <code>back-office-vm1</code>. If it is, I&rsquo;m using a service account; otherwise, I&rsquo;m using an empty string.</p><h3 id=reuse-code-in-the-peering-module>Reuse code in the peering module<a hidden class=anchor aria-hidden=true href=#reuse-code-in-the-peering-module>#</a></h3><p>First, let&rsquo;s see the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>locals</span> {
</span></span><span style=display:flex><span>  peerings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;back-office-services-peering&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;network&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_back_office</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;peer_network&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>services</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_services</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;services-back-office-peering&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;network&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>services</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_services</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;peer_network&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_back_office</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;back-office-storage-peering&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;network&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_back_office</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;peer_network&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>storage</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_storage</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;storage-back-office-peering&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;network&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>storage</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_storage</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;peer_network&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>terraform_remote_state</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>outputs</span>.<span style=color:#66d9ef>vpc_back_office</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_network_peering&#34; &#34;peerings&#34;</span> {
</span></span><span style=display:flex><span>  for_each <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>peerings</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  name         <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>key</span>
</span></span><span style=display:flex><span>  network      <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>.<span style=color:#66d9ef>network</span>
</span></span><span style=display:flex><span>  peer_network <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>.<span style=color:#66d9ef>peer_network</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>First, I define the <code>locals</code> block. It contains a map of maps. Each map contains information about peering. In this case, I can not use variables because when you assign value to a variable in
the <code>variable.tf</code> file or <code>terraform.tfvars</code> file, you can not use other variables. So, I have to use the <code>locals</code> block. In the <code>locals</code> block, I define a map for peering. The key is the peering
name, and the value is a map with two keys: <code>network</code> and <code>peer_network</code>. This setup allows me to use the <code>for_each</code> block in the <code>google_compute_network_peering</code> resource.</p><p>The final result is <a href=https://github.com/robert-nemet/pcne/tree/add_modules>here</a>.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>In this part, I refactored the project to make it more manageable: I split the project into environments, created a module for each VPC, and reused the code with modules. I used
already existing modules, and I wrote my module. I used the <code>terraform state mv</code> command to move resources from one state file to another. I used the <code>terraform state rm</code> command
to remove resources from the state file.</p><p>In the next part, let&rsquo;s try to use <a href=https://terragrunt.gruntwork.io/>Terragrunt</a> to make our code even more DRY and make running CLI commands easier.</p><p>Enjoy&mldr;</p><div class=subscribe><iframe src=https://rnemet.substack.com/embed width=480 height=320 style="border:1px solid #eee;background:#fff;margin:auto;display:block" frameborder=0 scrolling=no></iframe></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://rnemet.dev/tags/gcp/>gcp</a></li><li><a href=https://rnemet.dev/tags/terraform/>terraform</a></li><li><a href=https://rnemet.dev/tags/cloud/>cloud</a></li><li><a href=https://rnemet.dev/tags/networking/>networking</a></li><li><a href=https://rnemet.dev/tags/vpc/>vpc</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share GCP With Terraform: Refactor with Modules on twitter" href="https://twitter.com/intent/tweet/?text=GCP%20With%20Terraform%3a%20Refactor%20with%20Modules&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_refactor%2f&amp;hashtags=gcp%2cterraform%2ccloud%2cnetworking%2cvpc"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GCP With Terraform: Refactor with Modules on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_refactor%2f&amp;title=GCP%20With%20Terraform%3a%20Refactor%20with%20Modules&amp;summary=GCP%20With%20Terraform%3a%20Refactor%20with%20Modules&amp;source=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_refactor%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GCP With Terraform: Refactor with Modules on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_refactor%2f&title=GCP%20With%20Terraform%3a%20Refactor%20with%20Modules"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GCP With Terraform: Refactor with Modules on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_refactor%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GCP With Terraform: Refactor with Modules on whatsapp" href="https://api.whatsapp.com/send?text=GCP%20With%20Terraform%3a%20Refactor%20with%20Modules%20-%20https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_refactor%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share GCP With Terraform: Refactor with Modules on telegram" href="https://telegram.me/share/url?text=GCP%20With%20Terraform%3a%20Refactor%20with%20Modules&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_refactor%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://rnemet.dev/>DevCube</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>