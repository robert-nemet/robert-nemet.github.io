<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Exploring GCP With Terraform: VPCs, Firewall Rules And VMs | DevCube</title><meta name=keywords content="gcp,terraform,cloud,networking,vpc"><meta name=description content="GCP Networking with Terraform, part 1"><meta name=author content="Robert Nemet"><link rel=canonical href=https://rnemet.dev/posts/gcp/gcp_tf_vpc/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://rnemet.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rnemet.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rnemet.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://rnemet.dev/apple-touch-icon.png><link rel=mask-icon href=https://rnemet.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-L148RQBR36"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-L148RQBR36",{anonymize_ip:!1})}</script><meta property="og:title" content="Exploring GCP With Terraform: VPCs, Firewall Rules And VMs"><meta property="og:description" content="GCP Networking with Terraform, part 1"><meta property="og:type" content="article"><meta property="og:url" content="https://rnemet.dev/posts/gcp/gcp_tf_vpc/"><meta property="og:image" content="https://rnemet.dev/images/gcp-tf-start2.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-20T21:10:56+02:00"><meta property="article:modified_time" content="2023-08-20T21:10:56+02:00"><meta property="og:site_name" content="DevCube"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rnemet.dev/images/gcp-tf-start2.png"><meta name=twitter:title content="Exploring GCP With Terraform: VPCs, Firewall Rules And VMs"><meta name=twitter:description content="GCP Networking with Terraform, part 1"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rnemet.dev/posts/"},{"@type":"ListItem","position":2,"name":"Exploring GCP With Terraform: VPCs, Firewall Rules And VMs","item":"https://rnemet.dev/posts/gcp/gcp_tf_vpc/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Exploring GCP With Terraform: VPCs, Firewall Rules And VMs","name":"Exploring GCP With Terraform: VPCs, Firewall Rules And VMs","description":"GCP Networking with Terraform, part 1","keywords":["gcp","terraform","cloud","networking","vpc"],"articleBody":"This post will continue my previous post Exploring GCP With Terraform: Setting Up The Environment And Project. In this post, I’ll:\nCreate VPC with Terraform Create subnets/firewall rules Create VMs in the VPC How to access to VMs from outside and inside the VPC Info\nAlso, I’ll mention how to use gcloud to fetch information about created resources. At the end, I’ll mention two useful Terraform CLI commands. And why I’m structuring the project as I do.\nThis structuring is one of many ways to do it. It is just my way of doing it for now. The project needs refactoring, but for now, it is good enough.\nWarning\nI replaced the real project ID with _project-id_in the following examples. You need to replace it with your project ID.\nWhat is VPC in GCP? Virtual Private Network(VPC) is a virtual network defined in the cloud. It is a private network isolated from other networks in the cloud. It is responsible for:\nConnectivity between VMs Traffic distribution from GC load balancers to backends, Connecting on-premises networks with Cloud VPN or Cloud Interconnect, Network Load Balancers and proxies for internal Application Load Balancers. VPC is a global resource in GCP. A global resource means it is not bound to any region or zone. It is a logical resource that spans all regions.\nNote\nWe can distinguish between two types of resources: global and regional. Global resources are not bound to any region or zone. They are logical resources that span all regions.\nRegional resources are bound to a specific region. They are physical resources that exist in a specific region. Each region has at least three zones. Zones are isolated from each other and independent of each other. If one zone fails, other zones are not affected. You can perceive a zone as a data center. They are connected to a high-bandwidth, low-latency network.\nYou can imagine VPC as a logical container that holds all the other networking resources like firewalls, routes, subnets, etc.\nSubnets Subnets are logical partitions of the VPC’s IP address range. They are regional resources, which means they are bound to a specific region. You can specify the IP address range as IPv4 (single stack) or IPv4/IPv6 (dual-stack). They are allocating IP addresses to other resources in the subnet’s region.\nFirewall Rules Firewall rules are used to control traffic to and from different destinations. They are applied to the VPC network and are enforced at the VM instance level. Every VPC network has two implied firewall rules:\nimplied allow egress. Egress(outgoing) traffic is allowed to all destinations. implied deny ingress. Ingress(incoming) traffic is denied from all sources. As well as the implied rules, you can create your own rules.\nCreating VPC with Terraform I set up a base for my Terraform project in a previous post. Now, next to the base directory, I’m creating a new network directory with the same file structure. Let’s start with the provider.tf file:\nprovider \"google\" { project = var.project_id region = var.region zone = var.zone } terraform { required_version = \"\u003e=1.5.5\" required_providers { google = { source = \"hashicorp/google\" version = \"4.77.0\" } } backend \"gcs\" { bucket = \"terraform-states-project-id\" prefix = \"terraform/state/network\" } } Provider for all workflows is the same as in the base directory. The difference is the backend.gcs.prefix, which is now terraform/state/network. I’m using the same bucket. For the base workflow, you can change it to terraform/state/base.\nTip\nI’m splitting state files by workflows. The reason is to minimize the impact of changes from one workflow to another. There will be a dependency between workflows, but it should be minimal. Splitting state files would be necessary if multiple teams worked on the same project.\nAnd now creating the VPC in main.tf:\n# vpc: back office resource \"google_compute_network\" \"back_office\" { name = \"back-office\" description = \"Back office network\" auto_create_subnetworks = false routing_mode = \"REGIONAL\" } I’m creating a VPC named back-office and turning off the auto-creation of subnets. It is recommended to set auto_create_subnetworks to false and create subnets manually. This way, you have more control over the subnets. Otherwise, GCP will create a subnet in each region.\nNote\nYou can list all VPCs in a project with the following command:\n$ gcloud compute networks list NAME SUBNET_MODE BGP_ROUTING_MODE IPV4_RANGE GATEWAY_IPV4 back-office CUSTOM REGIONAL default AUTO REGIONAL services CUSTOM REGIONAL Notice a default VPC with AUTO subnet mode. The default VPC is created when you make a project. It has a subnet in each region. I created other VPCs.\nTo get info on a specific VPC, try:\n$ gcloud compute networks describe back-office autoCreateSubnetworks: false creationTimestamp: '2023-08-20T07:06:11.543-07:00' description: Back office network id: '1334556407227679868' kind: compute#network name: back-office networkFirewallPolicyEnforcementOrder: AFTER_CLASSIC_FIREWALL routingConfig: routingMode: REGIONAL selfLink: https://www.googleapis.com/compute/v1/projects/project-id/global/networks/back-office selfLinkWithId: https://www.googleapis.com/compute/v1/projects/project-id/global/networks/1334556407227679868 subnetworks: - https://www.googleapis.com/compute/v1/projects/project-id/regions/us-central1/subnetworks/back-office x_gcloud_bgp_routing_mode: REGIONAL x_gcloud_subnet_mode: CUSTOM I am setting the routing mode to REGIONAL. The routing_mode can be set to REGIONAL or GLOBAL. The REGIONAL means advertising routes to subnets in the same region. The GLOBAL means advertising routes to subnets in all regions.\nAs mentioned, more is needed. I need to add a subnet to the VPC:\n# subnet for back office resource \"google_compute_subnetwork\" \"back_office\" { name = \"back-office\" ip_cidr_range = \"10.1.0.0/24\" network = google_compute_network.back_office.self_link region = var.region } I’m creating a subnet named back-office and IP range 10.1.0.0/24. This subnet is attached to the back_office VPC in a predefined region.\nTip\nThe self_link refers to the resource and is a unique identifier for the resource. It is used to reference the resource in other resources.\nThe IP range is expressed as CIDR notation. The CIDR notation is a compact representation of an IP address and its associated routing prefix. The prefix is written after the IP address, and the prefix length is indicated by the number of bits set to 1 in the subnet mask. Check resources for more info.\nSo, I should have a VPC with a subnet. You can check the details of this subnet with gcloud:\n$ gcloud compute networks subnets describe back-office --region us-central1 creationTimestamp: '2023-08-21T13:12:57.423-07:00' enableFlowLogs: false fingerprint: crXvadZ1JQ= gatewayAddress: 10.1.0.1 id: '88832453211859900582' ipCidrRange: 10.1.0.0/24 kind: compute#subnetwork logConfig: aggregationInterval: INTERVAL_5_SEC enable: false flowSampling: 0.5 metadata: INCLUDE_ALL_METADATA name: back-office network: https://www.googleapis.com/compute/v1/projects/project-id/global/networks/back-office privateIpGoogleAccess: false privateIpv6GoogleAccess: DISABLE_GOOGLE_ACCESS purpose: PRIVATE region: https://www.googleapis.com/compute/v1/projects/project-id/regions/us-central1 selfLink: https://www.googleapis.com/compute/v1/projects/project-id/regions/us-central1/subnetworks/back-office stackType: IPV4_ONLY Add a VM Now is the time to test this. I’m creating a VM in this subnet:\nresource \"google_compute_instance\" \"bo_vm_test_alpha\" { name = \"bo-vm-test-alpha\" machine_type = \"f1-micro\" zone = var.zone tags = [\"bo-vm-test\"] scheduling { preemptible = true automatic_restart = false provisioning_model = \"SPOT\" } boot_disk { initialize_params { image = \"debian-cloud/debian-11\" } } network_interface { network = google_compute_network.back_office.self_link subnetwork = google_compute_subnetwork.back_office.self_link } } I’m creating a VM named bo-vm-test-alpha and machine type f1-micro. The VM is made in the zone us-central1-a. The VM is tagged with the bo-vm-test tag. The VM is preemptible, and it is using a spot instance. The boot disk is using the Debian 11 image. The VM is attached to the back_office VPC and back-office subnet.\nThis VM would be the cheapest in GCP, and it is not suitable for production. It is just for testing purposes. If you want to access it, go to the Console. There, choose the right project, and you should see your VM. Then go to the SSH button and click on it. It will open a new window with a terminal. You should be able to access the VM. Or not.\nAdd Firewall Rules You can’t. Why? Because I didn’t create a firewall rule to allow SSH:\nresource \"google_compute_firewall\" \"back_office_ssh\" { name = \"back-office-ssh\" network = google_compute_network.back_office.self_link source_ranges = [\"0.0.0.0/0\"] direction = \"INGRESS\" allow { protocol = \"tcp\" ports = [\"22\"] } } I’m creating a firewall rule named back-office-ssh, applied to the back_office VPC. The source range is 0.0.0.0/0, which means all internet. The direction is INGRESS, allowing TCP traffic on port 22.\nThis time, let’s try to connect with gcloud:\n$ gcloud compute ssh bo-vm-test-alpha --zone=us-central1-c --project=project-id External IP address was not found; defaulting to using IAP tunneling. WARNING: To increase the performance of the tunnel, consider installing NumPy. For instructions, please see https://cloud.google.com/iap/docs/using-tcp-forwarding#increasing_the_tcp_upload_bandwidth ERROR: (gcloud.compute.start-iap-tunnel) Error while connecting [4003: 'failed to connect to backend']. (Failed to connect to port 22) kex_exchange_identification: Connection closed by remote host Connection closed by UNKNOWN port 65535 Recommendation: To check for possible causes of SSH connectivity issues and get recommendations, rerun the ssh command with the --troubleshoot option. gcloud compute ssh bo-vm-test-alpha --project=project-id --zone=us-central1-c --troubleshoot Or, to investigate an IAP tunneling issue: gcloud compute ssh bo-vm-test-alpha --project=project-id --zone=us-central1-c --troubleshoot --tunnel-through-iap It is not working. I have two options to fix this: to add an external IP address to the VM or to use IAP tunneling. I’ll go with the second option. IAP tunneling is used to connect to VMs without external IP addresses. The VM I just created does not have an external IP address. So, let’s enable IAP tunneling:\n$ gcloud services enable iap.googleapis.com And add a firewall rule to allow ingress from the Cloud IAP for TCP forwarding:\nresource \"google_compute_firewall\" \"back_office_iap\" { name = \"back-office-iap\" network = google_compute_network.back_office.self_link source_ranges = [\"35.235.240.0/20\"] direction = \"INGRESS\" allow { protocol = \"tcp\" } } The CIDR range 35.235.240.0/20 is the range used by IAP. GCP specifies it see here for more info.\nRun terraform apply. Please wait for it to finish and try again. This time, it should work:\ngcloud compute ssh bo-vm-test-alpha --zone=us-central1-c --project=project-id External IP address was not found; defaulting to using IAP tunneling. WARNING: To increase the performance of the tunnel, consider installing NumPy. For instructions, please see https://cloud.google.com/iap/docs/using-tcp-forwarding#increasing_the_tcp_upload_bandwidth Warning: Permanently added 'compute.89653456855762463' (ED25519) to the list of known hosts. Linux bo-vm-test-alpha 5.10.0-24-cloud-amd64 #1 SMP Debian 5.10.179-5 (2023-08-08) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. rnemet@bo-vm-test-alpha:~$ It is working. I connect to the VM. Now, I can connect to the VM from another VM in the same subnet. I’ll create another VM in the same subnet. Just name it bo-vm-test-beta. When done, check it with gcloud:\n$ gcloud compute instances list NAME ZONE MACHINE_TYPE PREEMPTIBLE INTERNAL_IP EXTERNAL_IP STATUS bo-vm-test-alpha us-central1-c f1-micro true 10.1.0.5 RUNNING bo-vm-test-beta us-central1-c f1-micro true 10.1.0.6 RUNNING I see that alpha has IP 10.1.0.5 and beta has IP 10.1.0.6. Now I’ll try to ping alpha from beta. But first, I need to allow ICMP traffic:\nresource \"google_compute_firewall\" \"back_office_icmp\" { name = \"back-office-icmp\" network = google_compute_network.back_office.self_link source_ranges = [\"0.0.0.0/0\"] direction = \"INGRESS\" allow { protocol = \"icmp\" } } And then let’s try to ping alpha from the beta:\n$ gcloud compute ssh bo-vm-test-beta --zone=us-central1-c --project=project-id External IP address was not found; defaulting to using IAP tunneling. WARNING: To increase the performance of the tunnel, consider installing NumPy. For instructions, please see https://cloud.google.com/iap/docs/using-tcp-forwarding#increasing_the_tcp_upload_bandwidth Linux bo-vm-test-beta 5.10.0-24-cloud-amd64 #1 SMP Debian 5.10.179-5 (2023-08-08) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Aug 22 21:13:44 2023 from 35.235.244.34 rnemet@bo-vm-test-beta:~$ ping 10.1.0.6 PING 10.1.0.6 (10.1.0.6) 56(84) bytes of data. 64 bytes from 10.1.0.6: icmp_seq=1 ttl=64 time=0.014 ms 64 bytes from 10.1.0.6: icmp_seq=2 ttl=64 time=0.045 ms 64 bytes from 10.1.0.6: icmp_seq=3 ttl=64 time=0.035 ms 64 bytes from 10.1.0.6: icmp_seq=4 ttl=64 time=0.037 ms 64 bytes from 10.1.0.6: icmp_seq=5 ttl=64 time=0.029 ms 64 bytes from 10.1.0.6: icmp_seq=6 ttl=64 time=0.036 ms 64 bytes from 10.1.0.6: icmp_seq=7 ttl=64 time=0.022 ms 64 bytes from 10.1.0.6: icmp_seq=8 ttl=64 time=0.035 ms 64 bytes from 10.1.0.6: icmp_seq=9 ttl=64 time=0.028 ms 64 bytes from 10.1.0.6: icmp_seq=10 ttl=64 time=0.036 ms 64 bytes from 10.1.0.6: icmp_seq=11 ttl=64 time=0.036 ms ^C --- 10.1.0.6 ping statistics --- 11 packets transmitted, 11 received, 0% packet loss, time 10232ms rtt min/avg/max/mdev = 0.014/0.032/0.045/0.008 ms rnemet@bo-vm-test-beta:~$ Warning\nYou’ll need to wait a few minutes for the firewall rule to take effect. Or restart the VM:\n$ gcloud compute instances reset bo-vm-test-beta bo-vm-test-alpha --zone=us-central1-c Updated [https://www.googleapis.com/compute/v1/projects/project-id/zones/us-central1-c/instances/bo-vm-test-beta]. Updated [https://www.googleapis.com/compute/v1/projects/project-id/zones/us-central1-c/instances/bo-vm-test-alpha]. Terraform CLI: fmt and validate Frequent code changes make a mess. It is good practice to keep the code clean and formatted. Terraform has a command to format the code: terraform fmt. It will format the code in the current directory. It will also format all the files in the subdirectories. It is a good practice to run this command before committing the code.\nOn the other side, terraform validate will check the syntax of the code. It will check if the code is valid and complete. It will not check if the code is correct. For example, if you have a typo in the resource name, it will not catch it. It will detect if you have a typo in the resource type. It will also check if all the variables are defined.\nConclusion In this post, I created a VPC with a subnet and a VM in the subnet. I also made firewall rules to allow SSH and ICMP traffic. I used gcloud to check the created resources. I also used gcloud to connect to the VMs. I used IAP tunneling to connect to the VM without an external IP address. I also used terraform fmt and terraform validate to format and validate the code.\nI’ll create a second VPC and a VM for the next post. Then, explore how to connect VMs from different VPCs. As well as how to route traffic between VPCs.\nIf you find this helpful, please share it with others. If you have any questions or comments, please let me know in newsletter comments or via email.\nResources Regions and Zones VPC Overview VPCs and Subnets Firewall Rules CIDR Notation GCP IAP Tcp forwarding ","wordCount":"2297","inLanguage":"en","image":"https://rnemet.dev/images/gcp-tf-start2.png","datePublished":"2023-08-20T21:10:56+02:00","dateModified":"2023-08-20T21:10:56+02:00","author":{"@type":"Person","name":"Robert Nemet"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rnemet.dev/posts/gcp/gcp_tf_vpc/"},"publisher":{"@type":"Organization","name":"DevCube","logo":{"@type":"ImageObject","url":"https://rnemet.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rnemet.dev/ accesskey=h title="Home (Alt + H)"><img src=https://rnemet.dev/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rnemet.dev/posts/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://rnemet.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://rnemet.dev/posts/practical_k8s/ title="Practical k8s"><span>Practical k8s</span></a></li><li><a href=https://rnemet.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://rnemet.dev/about/ title="About Me"><span>About Me</span></a></li><li><a href=https://rnemet.dev/ title><span></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Exploring GCP With Terraform: VPCs, Firewall Rules And VMs</h1><div class=post-description>GCP Networking with Terraform, part 1</div><div class=post-meta><span title='2023-08-20 21:10:56 +0200 CEST'>August 20, 2023</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Robert Nemet</div></header><figure class=entry-cover><img loading=lazy src=https://rnemet.dev/images/gcp-tf-start2.png alt><p></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#what-is-vpc-in-gcp aria-label="What is VPC in GCP?">What is VPC in GCP?</a><ul><li><a href=#subnets aria-label=Subnets>Subnets</a></li><li><a href=#firewall-rules aria-label="Firewall Rules">Firewall Rules</a></li></ul></li><li><a href=#creating-vpc-with-terraform aria-label="Creating VPC with Terraform">Creating VPC with Terraform</a><ul><li><a href=#add-a-vm aria-label="Add a VM">Add a VM</a></li><li><a href=#add-firewall-rules aria-label="Add Firewall Rules">Add Firewall Rules</a></li></ul></li><li><a href=#terraform-cli-fmt-and-validate aria-label="Terraform CLI: fmt and validate">Terraform CLI: fmt and validate</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li><li><a href=#resources aria-label=Resources>Resources</a></li></ul></div></details></div><div class=post-content><p>This post will continue my previous post <a href=/posts/gcp/start_with_gcp/>Exploring GCP With Terraform: Setting Up The Environment And Project</a>.
In this post, I&rsquo;ll:</p><ul><li>Create VPC with Terraform</li><li>Create subnets/firewall rules</li><li>Create VMs in the VPC</li><li>How to access to VMs from outside and inside the VPC</li></ul><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice info"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"/></svg></span>Info</p><p>Also, I&rsquo;ll mention how to use <code>gcloud</code> to fetch information about created resources. At the end, I&rsquo;ll mention two useful Terraform CLI commands. And why I&rsquo;m structuring the project as I do.</p><p>This structuring is one of many ways to do it. It is just my way of doing it for now. The project needs refactoring, but for now, it is good enough.</p></div><div class="notice warning"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"/></svg></span>Warning</p><p>I replaced the real project ID with _project-id_in the following examples. You need to replace it with your project ID.</p></div><h2 id=what-is-vpc-in-gcp>What is VPC in GCP?<a hidden class=anchor aria-hidden=true href=#what-is-vpc-in-gcp>#</a></h2><p><strong>Virtual Private Network</strong>(VPC) is a virtual network defined in the cloud. It is a private network isolated from other networks in the cloud. It is responsible for:</p><ul><li>Connectivity between VMs</li><li>Traffic distribution from GC load balancers to backends,</li><li>Connecting on-premises networks with Cloud VPN or Cloud Interconnect,</li><li>Network Load Balancers and proxies for internal Application Load Balancers.</li></ul><p>VPC is a global resource in GCP. A global resource means it is not bound to any region or zone. It is a logical resource that spans all regions.</p><div class="notice note"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#note-notice"/></svg></span>Note</p><p>We can distinguish between two types of resources: <em>global and regional</em>. Global resources are not bound to any region or zone. They are logical resources that span all
regions.</p><p>Regional resources are bound to a specific region. They are physical resources that exist in a specific region. Each region has at least three zones. Zones are isolated
from each other and independent of each other. If one zone fails, other zones are not affected. You can perceive a zone as a data center. They are connected to a
high-bandwidth, low-latency network.</p></div><p>You can imagine VPC as a logical container that holds all the other networking resources like firewalls, routes, subnets, etc.</p><h3 id=subnets>Subnets<a hidden class=anchor aria-hidden=true href=#subnets>#</a></h3><p>Subnets are logical partitions of the VPC&rsquo;s IP address range. They are regional resources, which means they are bound to a specific region. You can specify the IP
address range as IPv4 (single stack) or IPv4/IPv6 (dual-stack). They are allocating IP addresses to other resources in the subnet&rsquo;s region.</p><h3 id=firewall-rules>Firewall Rules<a hidden class=anchor aria-hidden=true href=#firewall-rules>#</a></h3><p>Firewall rules are used to control traffic to and from different destinations. They are applied to the VPC network and are enforced at the VM instance level. Every VPC
network has two implied firewall rules:</p><ul><li><em>implied allow egress</em>. Egress(outgoing) traffic is allowed to all destinations.</li><li><em>implied deny ingress</em>. Ingress(incoming) traffic is denied from all sources.</li></ul><p>As well as the implied rules, you can create your own rules.</p><h2 id=creating-vpc-with-terraform>Creating VPC with Terraform<a hidden class=anchor aria-hidden=true href=#creating-vpc-with-terraform>#</a></h2><p>I set up a base for my Terraform project in a <a href=/posts/gcp/start_with_gcp/>previous post</a>. Now, next to the <code>base</code> directory, I&rsquo;m creating a new <code>network</code> directory
with the same file structure. Let&rsquo;s start with the <code>provider.tf</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;google&#34;</span> {
</span></span><span style=display:flex><span>  project <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>project_id</span>
</span></span><span style=display:flex><span>  region  <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>region</span>
</span></span><span style=display:flex><span>  zone    <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>zone</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>terraform</span> {
</span></span><span style=display:flex><span>  required_version <span style=color:#f92672>=</span> &#34;&gt;<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>5</span>.<span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>required_providers</span> {
</span></span><span style=display:flex><span>    google <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hashicorp/google&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;4.77.0&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>backend</span> <span style=color:#e6db74>&#34;gcs&#34;</span> {
</span></span><span style=display:flex><span>    bucket <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-states-project-id&#34;</span>
</span></span><span style=display:flex><span>    prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform/state/network&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Provider for all workflows is the same as in the <code>base</code> directory. The difference is the <code>backend.gcs.prefix</code>, which is now <code>terraform/state/network</code>. I&rsquo;m using the
same bucket. For the <code>base</code> workflow, you can change it to <code>terraform/state/base</code>.</p><div class="notice tip"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>Tip</p><p>I&rsquo;m splitting state files by workflows. The reason is to minimize the impact of changes from one workflow to another. There will be a dependency between workflows, but
it should be minimal. Splitting state files would be necessary if multiple teams worked on the same project.</p></div><p>And now creating the VPC in <code>main.tf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># vpc: back office
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_network&#34; &#34;back_office&#34;</span> {
</span></span><span style=display:flex><span>  name                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office&#34;</span>
</span></span><span style=display:flex><span>  description             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Back office network&#34;</span>
</span></span><span style=display:flex><span>  auto_create_subnetworks <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  routing_mode            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;REGIONAL&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m creating a VPC named <code>back-office</code> and turning off the auto-creation of subnets. It is recommended to set <code>auto_create_subnetworks</code> to <code>false</code> and create subnets
manually. This way, you have more control over the subnets. Otherwise, GCP will create a subnet in each region.</p><div class="notice note"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#note-notice"/></svg></span>Note</p><p>You can list all VPCs in a project with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud compute networks list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME         SUBNET_MODE  BGP_ROUTING_MODE  IPV4_RANGE  GATEWAY_IPV4
</span></span><span style=display:flex><span>back-office  CUSTOM       REGIONAL
</span></span><span style=display:flex><span>default      AUTO         REGIONAL
</span></span><span style=display:flex><span>services     CUSTOM       REGIONAL
</span></span></code></pre></div><p>Notice a <em>default</em> VPC with <em>AUTO</em> subnet mode. The <code>default</code> VPC is created when you make a project. It has a subnet in each region. I created other VPCs.</p><p>To get info on a specific VPC, try:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud compute networks describe back-office
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>autoCreateSubnetworks: false
</span></span><span style=display:flex><span>creationTimestamp: <span style=color:#e6db74>&#39;2023-08-20T07:06:11.543-07:00&#39;</span>
</span></span><span style=display:flex><span>description: Back office network
</span></span><span style=display:flex><span>id: <span style=color:#e6db74>&#39;1334556407227679868&#39;</span>
</span></span><span style=display:flex><span>kind: compute#network
</span></span><span style=display:flex><span>name: back-office
</span></span><span style=display:flex><span>networkFirewallPolicyEnforcementOrder: AFTER_CLASSIC_FIREWALL
</span></span><span style=display:flex><span>routingConfig:
</span></span><span style=display:flex><span>  routingMode: REGIONAL
</span></span><span style=display:flex><span>selfLink: https://www.googleapis.com/compute/v1/projects/project-id/global/networks/back-office
</span></span><span style=display:flex><span>selfLinkWithId: https://www.googleapis.com/compute/v1/projects/project-id/global/networks/1334556407227679868
</span></span><span style=display:flex><span>subnetworks:
</span></span><span style=display:flex><span>- https://www.googleapis.com/compute/v1/projects/project-id/regions/us-central1/subnetworks/back-office
</span></span><span style=display:flex><span>x_gcloud_bgp_routing_mode: REGIONAL
</span></span><span style=display:flex><span>x_gcloud_subnet_mode: CUSTOM
</span></span></code></pre></div></div><p>I am setting the routing mode to <code>REGIONAL</code>. The <code>routing_mode</code> can be set to <code>REGIONAL</code> or <code>GLOBAL</code>. The <code>REGIONAL</code> means advertising routes to subnets in the same
region. The <code>GLOBAL</code> means advertising routes to subnets in all regions.</p><p>As mentioned, more is needed. I need to add a subnet to the VPC:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e># subnet for back office
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_subnetwork&#34; &#34;back_office&#34;</span> {
</span></span><span style=display:flex><span>  name          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office&#34;</span>
</span></span><span style=display:flex><span>  ip_cidr_range <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.1.0.0/24&#34;</span>
</span></span><span style=display:flex><span>  network       <span style=color:#f92672>=</span> <span style=color:#66d9ef>google_compute_network</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>self_link</span>
</span></span><span style=display:flex><span>  region        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>region</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m creating a subnet named <code>back-office</code> and IP range <code>10.1.0.0/24</code>. This subnet is attached to the <code>back_office</code> VPC in a predefined region.</p><div class="notice tip"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>Tip</p><p>The <em>self_link</em> refers to the resource and is a unique identifier for the resource. It is used to reference the resource in other resources.</p><p>The IP range is expressed as CIDR notation. The CIDR notation is a compact representation of an IP address and its associated routing prefix. The prefix is written
after the IP address, and the prefix length is indicated by the number of bits set to 1 in the subnet mask. Check resources for more info.</p></div><p>So, I should have a VPC with a subnet. You can check the details of this subnet with <code>gcloud</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud compute networks subnets describe back-office --region us-central1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>creationTimestamp: <span style=color:#e6db74>&#39;2023-08-21T13:12:57.423-07:00&#39;</span>
</span></span><span style=display:flex><span>enableFlowLogs: false
</span></span><span style=display:flex><span>fingerprint: crXvadZ1JQ<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>gatewayAddress: 10.1.0.1
</span></span><span style=display:flex><span>id: <span style=color:#e6db74>&#39;88832453211859900582&#39;</span>
</span></span><span style=display:flex><span>ipCidrRange: 10.1.0.0/24
</span></span><span style=display:flex><span>kind: compute#subnetwork
</span></span><span style=display:flex><span>logConfig:
</span></span><span style=display:flex><span>  aggregationInterval: INTERVAL_5_SEC
</span></span><span style=display:flex><span>  enable: false
</span></span><span style=display:flex><span>  flowSampling: 0.5
</span></span><span style=display:flex><span>  metadata: INCLUDE_ALL_METADATA
</span></span><span style=display:flex><span>name: back-office
</span></span><span style=display:flex><span>network: https://www.googleapis.com/compute/v1/projects/project-id/global/networks/back-office
</span></span><span style=display:flex><span>privateIpGoogleAccess: false
</span></span><span style=display:flex><span>privateIpv6GoogleAccess: DISABLE_GOOGLE_ACCESS
</span></span><span style=display:flex><span>purpose: PRIVATE
</span></span><span style=display:flex><span>region: https://www.googleapis.com/compute/v1/projects/project-id/regions/us-central1
</span></span><span style=display:flex><span>selfLink: https://www.googleapis.com/compute/v1/projects/project-id/regions/us-central1/subnetworks/back-office
</span></span><span style=display:flex><span>stackType: IPV4_ONLY
</span></span></code></pre></div><h3 id=add-a-vm>Add a VM<a hidden class=anchor aria-hidden=true href=#add-a-vm>#</a></h3><p>Now is the time to test this. I&rsquo;m creating a VM in this subnet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_instance&#34; &#34;bo_vm_test_alpha&#34;</span> {
</span></span><span style=display:flex><span>  name         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bo-vm-test-alpha&#34;</span>
</span></span><span style=display:flex><span>  machine_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;f1-micro&#34;</span>
</span></span><span style=display:flex><span>  zone         <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>zone</span>
</span></span><span style=display:flex><span>  tags         <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;bo-vm-test&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>scheduling</span> {
</span></span><span style=display:flex><span>    preemptible        <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    automatic_restart  <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    provisioning_model <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SPOT&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>boot_disk</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>initialize_params</span> {
</span></span><span style=display:flex><span>      image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;debian-cloud/debian-11&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>network_interface</span> {
</span></span><span style=display:flex><span>    network    <span style=color:#f92672>=</span> <span style=color:#66d9ef>google_compute_network</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>self_link</span>
</span></span><span style=display:flex><span>    subnetwork <span style=color:#f92672>=</span> <span style=color:#66d9ef>google_compute_subnetwork</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>self_link</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m creating a VM named <code>bo-vm-test-alpha</code> and machine type <code>f1-micro</code>. The VM is made in the zone <code>us-central1-a</code>. The VM is tagged with the <code>bo-vm-test</code> tag.
The VM is preemptible, and it is using a spot instance. The boot disk is using the Debian 11 image. The VM is attached to the <code>back_office</code> VPC and <code>back-office</code> subnet.</p><p>This VM would be the cheapest in GCP, and it is not suitable for production. It is just for testing purposes. If you want to access it, go to the <a href=https://console.cloud.google.com/compute/instances>Console</a>. There, choose the right project, and you should see your VM. Then go to the <em>SSH</em> button and click on it. It will
open a new window with a terminal. You should be able to access the VM. Or not.</p><h3 id=add-firewall-rules>Add Firewall Rules<a hidden class=anchor aria-hidden=true href=#add-firewall-rules>#</a></h3><p>You can&rsquo;t. Why? Because I didn&rsquo;t create a firewall rule to allow SSH:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_firewall&#34; &#34;back_office_ssh&#34;</span> {
</span></span><span style=display:flex><span>  name    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office-ssh&#34;</span>
</span></span><span style=display:flex><span>  network <span style=color:#f92672>=</span> <span style=color:#66d9ef>google_compute_network</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>self_link</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  source_ranges <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>]
</span></span><span style=display:flex><span>  direction     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;INGRESS&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>allow</span> {
</span></span><span style=display:flex><span>    protocol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>    ports    <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;22&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m creating a firewall rule named <code>back-office-ssh</code>, applied to the <code>back_office</code> VPC. The source range is <code>0.0.0.0/0</code>, which means all internet.
The direction is <code>INGRESS</code>, allowing TCP traffic on port <code>22</code>.</p><p>This time, let&rsquo;s try to connect with <code>gcloud</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud compute ssh bo-vm-test-alpha --zone<span style=color:#f92672>=</span>us-central1-c  --project<span style=color:#f92672>=</span>project-id
</span></span><span style=display:flex><span>External IP address was not found; defaulting to using IAP tunneling.
</span></span><span style=display:flex><span>WARNING:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To increase the performance of the tunnel, consider installing NumPy. For instructions,
</span></span><span style=display:flex><span>please see https://cloud.google.com/iap/docs/using-tcp-forwarding#increasing_the_tcp_upload_bandwidth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ERROR: <span style=color:#f92672>(</span>gcloud.compute.start-iap-tunnel<span style=color:#f92672>)</span> Error <span style=color:#66d9ef>while</span> connecting <span style=color:#f92672>[</span>4003: <span style=color:#e6db74>&#39;failed to connect to backend&#39;</span><span style=color:#f92672>]</span>. <span style=color:#f92672>(</span>Failed to connect to port 22<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>kex_exchange_identification: Connection closed by remote host
</span></span><span style=display:flex><span>Connection closed by UNKNOWN port <span style=color:#ae81ff>65535</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Recommendation: To check <span style=color:#66d9ef>for</span> possible causes of SSH connectivity issues and get
</span></span><span style=display:flex><span>recommendations, rerun the ssh command with the --troubleshoot option.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute ssh bo-vm-test-alpha --project<span style=color:#f92672>=</span>project-id --zone<span style=color:#f92672>=</span>us-central1-c --troubleshoot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Or, to investigate an IAP tunneling issue:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute ssh bo-vm-test-alpha --project<span style=color:#f92672>=</span>project-id --zone<span style=color:#f92672>=</span>us-central1-c --troubleshoot --tunnel-through-iap
</span></span></code></pre></div><p>It is not working. I have two options to fix this: to add an external IP address to the VM or to use IAP tunneling. I&rsquo;ll go with the second option. IAP tunneling is
used to connect to VMs without external IP addresses. The VM I just created does not have an external IP address. So, let&rsquo;s enable IAP tunneling:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud services enable iap.googleapis.com
</span></span></code></pre></div><p>And add a firewall rule to allow ingress from the Cloud IAP for TCP forwarding:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_firewall&#34; &#34;back_office_iap&#34;</span> {
</span></span><span style=display:flex><span>  name    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office-iap&#34;</span>
</span></span><span style=display:flex><span>  network <span style=color:#f92672>=</span> <span style=color:#66d9ef>google_compute_network</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>self_link</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  source_ranges <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;35.235.240.0/20&#34;</span>]
</span></span><span style=display:flex><span>  direction     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;INGRESS&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>allow</span> {
</span></span><span style=display:flex><span>    protocol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The CIDR range <code>35.235.240.0/20</code> is the range used by IAP. GCP specifies it <a href=https://cloud.google.com/iap/docs/using-tcp-forwarding#create-firewall-rule>see here for more info</a>.</p><p>Run <code>terraform apply</code>. Please wait for it to finish and try again. This time, it should work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> gcloud compute ssh bo-vm-test-alpha --zone<span style=color:#f92672>=</span>us-central1-c  --project<span style=color:#f92672>=</span>project-id
</span></span><span style=display:flex><span>External IP address was not found; defaulting to using IAP tunneling.
</span></span><span style=display:flex><span>WARNING:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To increase the performance of the tunnel, consider installing NumPy. For instructions,
</span></span><span style=display:flex><span>please see https://cloud.google.com/iap/docs/using-tcp-forwarding#increasing_the_tcp_upload_bandwidth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Warning: Permanently added <span style=color:#e6db74>&#39;compute.89653456855762463&#39;</span> <span style=color:#f92672>(</span>ED25519<span style=color:#f92672>)</span> to the list of known hosts.
</span></span><span style=display:flex><span>Linux bo-vm-test-alpha 5.10.0-24-cloud-amd64 <span style=color:#75715e>#1 SMP Debian 5.10.179-5 (2023-08-08) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>rnemet@bo-vm-test-alpha:~$
</span></span></code></pre></div><p>It is working. I connect to the VM. Now, I can connect to the VM from another VM in the same subnet. I&rsquo;ll create another VM in the same subnet. Just name it
<code>bo-vm-test-beta</code>. When done, check it with <code>gcloud</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud compute instances list
</span></span><span style=display:flex><span>NAME              ZONE           MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP  STATUS
</span></span><span style=display:flex><span>bo-vm-test-alpha  us-central1-c  f1-micro      true         10.1.0.5                  RUNNING
</span></span><span style=display:flex><span>bo-vm-test-beta   us-central1-c  f1-micro      true         10.1.0.6                  RUNNING
</span></span></code></pre></div><p>I see that <em>alpha</em> has IP 10.1.0.5 and <em>beta</em> has IP 10.1.0.6. Now I&rsquo;ll try to <code>ping</code> <em>alpha</em> from <em>beta</em>. But first, I need to allow ICMP traffic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_firewall&#34; &#34;back_office_icmp&#34;</span> {
</span></span><span style=display:flex><span>  name    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;back-office-icmp&#34;</span>
</span></span><span style=display:flex><span>  network <span style=color:#f92672>=</span> <span style=color:#66d9ef>google_compute_network</span>.<span style=color:#66d9ef>back_office</span>.<span style=color:#66d9ef>self_link</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  source_ranges <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>]
</span></span><span style=display:flex><span>  direction     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;INGRESS&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>allow</span> {
</span></span><span style=display:flex><span>    protocol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;icmp&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And then let&rsquo;s try to ping <em>alpha</em> from the <em>beta</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud compute ssh bo-vm-test-beta --zone<span style=color:#f92672>=</span>us-central1-c  --project<span style=color:#f92672>=</span>project-id
</span></span><span style=display:flex><span>External IP address was not found; defaulting to using IAP tunneling.
</span></span><span style=display:flex><span>WARNING:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To increase the performance of the tunnel, consider installing NumPy. For instructions,
</span></span><span style=display:flex><span>please see https://cloud.google.com/iap/docs/using-tcp-forwarding#increasing_the_tcp_upload_bandwidth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Linux bo-vm-test-beta 5.10.0-24-cloud-amd64 <span style=color:#75715e>#1 SMP Debian 5.10.179-5 (2023-08-08) x86_64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style=display:flex><span>the exact distribution terms <span style=color:#66d9ef>for</span> each program are described in the
</span></span><span style=display:flex><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style=display:flex><span>permitted by applicable law.
</span></span><span style=display:flex><span>Last login: Tue Aug <span style=color:#ae81ff>22</span> 21:13:44 <span style=color:#ae81ff>2023</span> from 35.235.244.34
</span></span><span style=display:flex><span>rnemet@bo-vm-test-beta:~$ ping 10.1.0.6
</span></span><span style=display:flex><span>PING 10.1.0.6 <span style=color:#f92672>(</span>10.1.0.6<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.014 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.045 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.035 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.037 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.029 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.036 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.022 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.035 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.028 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.036 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 10.1.0.6: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span> time<span style=color:#f92672>=</span>0.036 ms
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>--- 10.1.0.6 ping statistics ---
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span> packets transmitted, <span style=color:#ae81ff>11</span> received, 0% packet loss, time 10232ms
</span></span><span style=display:flex><span>rtt min/avg/max/mdev <span style=color:#f92672>=</span> 0.014/0.032/0.045/0.008 ms
</span></span><span style=display:flex><span>rnemet@bo-vm-test-beta:~$
</span></span></code></pre></div><div class="notice warning"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"/></svg></span>Warning</p><p>You&rsquo;ll need to wait a few minutes for the firewall rule to take effect. Or restart the VM:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud compute instances reset bo-vm-test-beta bo-vm-test-alpha --zone<span style=color:#f92672>=</span>us-central1-c
</span></span><span style=display:flex><span>Updated <span style=color:#f92672>[</span>https://www.googleapis.com/compute/v1/projects/project-id/zones/us-central1-c/instances/bo-vm-test-beta<span style=color:#f92672>]</span>.
</span></span><span style=display:flex><span>Updated <span style=color:#f92672>[</span>https://www.googleapis.com/compute/v1/projects/project-id/zones/us-central1-c/instances/bo-vm-test-alpha<span style=color:#f92672>]</span>.
</span></span></code></pre></div></div><h2 id=terraform-cli-fmt-and-validate>Terraform CLI: fmt and validate<a hidden class=anchor aria-hidden=true href=#terraform-cli-fmt-and-validate>#</a></h2><p>Frequent code changes make a mess. It is good practice to keep the code clean and formatted. Terraform has a command to format the code: <code>terraform fmt</code>. It will
format the code in the current directory. It will also format all the files in the subdirectories. It is a good practice to run this command before committing the
code.</p><p>On the other side, <code>terraform validate</code> will check the syntax of the code. It will check if the code is valid and complete. It will not check if the code is correct.
For example, if you have a typo in the resource name, it will not catch it. It will detect if you have a typo in the resource type. It will also check if all the
variables are defined.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>In this post, I created a VPC with a subnet and a VM in the subnet. I also made firewall rules to allow SSH and ICMP traffic. I used <code>gcloud</code> to check the created
resources. I also used <code>gcloud</code> to connect to the VMs. I used IAP tunneling to connect to the VM without an external IP address. I also used <code>terraform fmt</code> and
<code>terraform validate</code> to format and validate the code.</p><p>I&rsquo;ll create a second VPC and a VM for the next post. Then, explore how to connect VMs from different VPCs. As well as how to route traffic between VPCs.</p><p>If you find this helpful, please share it with others. If you have any questions or comments, please let me know in newsletter comments or via email.</p><h2 id=resources>Resources<a hidden class=anchor aria-hidden=true href=#resources>#</a></h2><ul><li><a href=https://cloud.google.com/compute/docs/regions-zones>Regions and Zones</a></li><li><a href=https://cloud.google.com/vpc/docs/overview>VPC Overview</a></li><li><a href=https://cloud.google.com/vpc/docs/subnets>VPCs and Subnets</a></li><li><a href=https://cloud.google.com/vpc/docs/firewalls>Firewall Rules</a></li><li><a href=https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing>CIDR Notation</a></li><li><a href=https://cloud.google.com/iap/docs/using-tcp-forwarding>GCP IAP Tcp forwarding</a></li></ul><div class=subscribe><iframe src=https://rnemet.substack.com/embed width=480 height=320 style="border:1px solid #eee;background:#fff;margin:auto;display:block" frameborder=0 scrolling=no></iframe></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://rnemet.dev/tags/gcp/>gcp</a></li><li><a href=https://rnemet.dev/tags/terraform/>terraform</a></li><li><a href=https://rnemet.dev/tags/cloud/>cloud</a></li><li><a href=https://rnemet.dev/tags/networking/>networking</a></li><li><a href=https://rnemet.dev/tags/vpc/>vpc</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: VPCs, Firewall Rules And VMs on twitter" href="https://twitter.com/intent/tweet/?text=Exploring%20GCP%20With%20Terraform%3a%20VPCs%2c%20Firewall%20Rules%20And%20VMs&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_vpc%2f&amp;hashtags=gcp%2cterraform%2ccloud%2cnetworking%2cvpc"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: VPCs, Firewall Rules And VMs on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_vpc%2f&amp;title=Exploring%20GCP%20With%20Terraform%3a%20VPCs%2c%20Firewall%20Rules%20And%20VMs&amp;summary=Exploring%20GCP%20With%20Terraform%3a%20VPCs%2c%20Firewall%20Rules%20And%20VMs&amp;source=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_vpc%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: VPCs, Firewall Rules And VMs on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_vpc%2f&title=Exploring%20GCP%20With%20Terraform%3a%20VPCs%2c%20Firewall%20Rules%20And%20VMs"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: VPCs, Firewall Rules And VMs on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_vpc%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: VPCs, Firewall Rules And VMs on whatsapp" href="https://api.whatsapp.com/send?text=Exploring%20GCP%20With%20Terraform%3a%20VPCs%2c%20Firewall%20Rules%20And%20VMs%20-%20https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_vpc%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: VPCs, Firewall Rules And VMs on telegram" href="https://telegram.me/share/url?text=Exploring%20GCP%20With%20Terraform%3a%20VPCs%2c%20Firewall%20Rules%20And%20VMs&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fgcp_tf_vpc%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://rnemet.dev/>DevCube</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>