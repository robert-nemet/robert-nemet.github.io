<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Exploring GCP With Terraform: Setting Up The Environment And Project | DevCube</title>
<meta name=keywords content="gcp,terraform,cloud"><meta name=description content="This topic is nothing new. There are many articles and tutorials on the internet about this. I&rsquo;ll be setting up a Terraform project to explore GCP. I cover the basics of Terraform and GCP.


Warning"><meta name=author content="Robert Nemet"><link rel=canonical href=https://rnemet.dev/posts/gcp/start_with_gcp/><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://rnemet.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rnemet.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rnemet.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://rnemet.dev/apple-touch-icon.png><link rel=mask-icon href=https://rnemet.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://rnemet.dev/posts/gcp/start_with_gcp/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-L148RQBR36"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-L148RQBR36")}</script><meta property="og:url" content="https://rnemet.dev/posts/gcp/start_with_gcp/"><meta property="og:site_name" content="DevCube"><meta property="og:title" content="Exploring GCP With Terraform: Setting Up The Environment And Project"><meta property="og:description" content="This topic is nothing new. There are many articles and tutorials on the internet about this. I’ll be setting up a Terraform project to explore GCP. I cover the basics of Terraform and GCP.
Warning"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-16T21:10:56+02:00"><meta property="article:modified_time" content="2023-08-16T21:10:56+02:00"><meta property="article:tag" content="Gcp"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Cloud"><meta property="og:image" content="https://rnemet.dev/images/gcp-tf-start.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rnemet.dev/images/gcp-tf-start.png"><meta name=twitter:title content="Exploring GCP With Terraform: Setting Up The Environment And Project"><meta name=twitter:description content="This topic is nothing new. There are many articles and tutorials on the internet about this. I&rsquo;ll be setting up a Terraform project to explore GCP. I cover the basics of Terraform and GCP.


Warning"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://rnemet.dev/posts/"},{"@type":"ListItem","position":2,"name":"Exploring GCP With Terraform: Setting Up The Environment And Project","item":"https://rnemet.dev/posts/gcp/start_with_gcp/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Exploring GCP With Terraform: Setting Up The Environment And Project","name":"Exploring GCP With Terraform: Setting Up The Environment And Project","description":"This topic is nothing new. There are many articles and tutorials on the internet about this. I\u0026rsquo;ll be setting up a Terraform project to explore GCP. I cover the basics of Terraform and GCP.\nWarning\n","keywords":["gcp","terraform","cloud"],"articleBody":"This topic is nothing new. There are many articles and tutorials on the internet about this. I’ll be setting up a Terraform project to explore GCP. I cover the basics of Terraform and GCP.\nWarning\nI replaced the real project ID with project-id in the following examples. You need to replace it with your project ID.\nPrerequisites Create GCP Project First, you must create a GCP account, then create a project and set up billing on that project. If you already have a Gmail account, you can use it to make a GCP account. Head to the Google Cloud Console and create a new project.\nMy plan is to pay for the services I use. I need to feel the pain and learn more about cost optimization. You can be more intelligent than me and use the free tier for the first year. After that, you will be charged for the services you use. You can find more information about the free tier here.\nInstall And Set Up The gcloud CLI Tool The gcloud CLI is a part of the Google Cloud SDK. You can find the installation instructions for gcloud CLI here. Next, you need to set up the gcloud CLI tool. Docs are here.\nFor future reference, you can find the list of all gcloud commands here.\nAfter initialization, you can always check what you set with the following command:\n$ gcloud config list [SECTION/PROPERTY] [--all] Install Terraform CLI Tool You can find the Terraform installation instructions here. But I’m not following the instructions. I’m using the tool tfenv to manage Terraform versions. Other tools can do that. You can use asdf, too. I saw that asdf can do more than manage Terraform versions.\nLet me explain how I do it since I use tfenv. I assume you already installed it. I use tfenv to install the desired version of Terraform. And to set it as default:\n$ tfenv install 1.5.5 $ tfenv use 1.5.5 You can check the version with the following command:\n$ terraform --version I’ll explain later why I use tfenv.\nOther Tools I Use Other tools I’ll be using are:\ntask - a task runner and a replacement for make git - version control system direnv - unconsciously set and unset environment variables Setting Up The Project I’m using this layout for now:\n. # project root ├── README.md # project README ├── LICENSE # project LICENSE ├── .gitignore # project .gitignore ├── Taskfile.yml # project taskfile └── gcp # GCP Terraform code └── base # base GCP Terraform code ├── README.md # base README ├── .terraform-version # base terraform version ├── main.tf # base main.tf ├── outputs.tf # base outputs.tf ├── variables.tf # base variables.tf ├── terraform.tfvars # base terraform.tfvars └── provider.tf # base provider.tf Let me quickly explain. The gcp directory is the root directory for all GCP Terraform code. The base directory is the root directory for all base GCP Terraform code. That base code would cover the following, for now:\nCreating a bucket for storing Terraform state Creating Key and KeyRing for encrypting Terraform state file Setting up Terraform’s backend Setting up Terraform provider Setting up Terraform base variables Just create the directories and files, and we are ready to go.\nInfo\nOh, one small thing. The file .terraform-version is used by tfenv to set and pin the Terraform version. Even if I set with tfenv the default Terraform version, I use this file to say which Terraform version should be used for the base. If you are using tfenv do:\n$ cd gcp/base $ tfenv pin Pinned version by writing \"1.5.5\" to /somepath/gcp/base/.terraform-version With this, it does not matter what is the default Terraform version. The tfenv will use the version from the .terraform-version file. If, for some reason, you do not have the desired version, tfenv will install it for you.\nSetting Up Provider The first thing we need to do is to set up the provider. I’m using the latest version of the provider. You can find the latest version here:\nprovider \"google\" { project = var.project_id region = var.region zone = var.zone } terraform { required_version = \"\u003e=1.5.5\" required_providers { google = { source = \"hashicorp/google\" version = \"4.77.0\" } } backend \"local\" { path = \"local-state.tfstate\" } } I’m using the local backend for now. I plan to switch to the gcs backend later. The local backend is used for storing the Terraform state locally. The state file is called local-state.tfstate. And it will contain the Terraform state for the base. It is not encrypted. My plan is to keep it safe and encrypted.\nBlock terraform sets the required Terraform provider version, provider, and backend. You can find more here.\nThe provider block configures the provider by setting the project ID, region, and zone. You probably noticed that I’m using variables.\nSetting Up Variables I’m using variables for defining variables I’ll be using in the base. I’m using the following variables:\nvariable \"project_id\" { description = \"project id\" type = string } variable \"region\" { description = \"default region\" type = string } variable \"zone\" { description = \"default zone\" type = string } Once you defined the variables, you need to set them. You can do that in the terraform.tfvars file:\nproject_id = \"my-project\" region = \"europe-west1\" zone = \"europe-west1-b\" You should avoid committing the terraform.tfvars file. It may contain sensitive information. I’ll show you how to handle that later. But for now, you must create the terraform.tfvars file and set the variables. For the project_id variable, you need to set the project ID you created earlier. Choose the region and zone that is closest to you. You can find the list of regions and zones here.\nInfo\nIs this important? Yes, it is.\nYou need to choose the region and zone carefully, considering reliability, availability, and cost into account. For your users to have the best experience, your servers must be close to them and deliver the content quickly. It would be best if you considered the cost, too.\nTo learn more about choosing the correct region and zone, you can find more here in Google documentation.\nInit, Plan, and Apply At this moment, I can initialize the Terraform workflow:\n$ terraform init Initializing the backend... Successfully configured the backend \"local\"! Terraform will automatically use this backend unless the backend configuration changes. Initializing provider plugins... - Finding hashicorp/google versions matching \"4.77.0\"... - Installing hashicorp/google v4.77.0... - Installed hashicorp/google v4.77.0 (signed by HashiCorp) Terraform has created a lock file .terraform.lock.hcl to record the provider selections it made above. Include this file in your version control repository so that Terraform can guarantee to make the same selections by default when you run \"terraform init\" in the future. Terraform has been successfully initialized! You may now begin working with Terraform. Try running \"terraform plan\" to see any changes that are required for your infrastructure. All Terraform commands should now work. If you ever set or change modules or backend configuration for Terraform, rerun this command to reinitialize your working directory. If you forget, other commands will detect it and remind you to do so if necessary. This will create a directory .terraform and file .terraform.lock.hcl file. You should include .terraform.lock.hcl in your commit. It is used to lock the provider version. If you run terraform init again, it will use the same provider version. The folder .terraform stores the provider plugins and other files required for Terraform to work.\nNext, I can run terraform plan:\n$ terraform plan No changes. Your infrastructure matches the configuration. Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed. This will show me what Terraform will do. Since I did not create any resources, it will not do anything. But it is good to run terraform plan before terraform apply.\nNext, I can run terraform apply:\n$ terraform apply No changes. Your infrastructure matches the configuration. Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed. Apply complete! Resources: 0 added, 0 changed, 0 destroyed. Well, this is expected. I did not create any resources. If there are any changes, Terraform will show you what it will do and ask you to confirm them. If you want to apply the changes, type yes and hit enter.\nSetting Up The Bucket From the terraform init output, I can see that the backend is configured. It is configured to use the local backend. My goal is to use the gcs backend. That means I want to store the Terraform state file in the GCP bucket. Let’s look at how to do it:\ndata \"google_storage_project_service_account\" \"gcs_account\" { } resource \"google_kms_key_ring\" \"tf_states\" { name = \"terraform-state-key-ring\" location = \"us\" lifecycle { prevent_destroy = true } } resource \"google_kms_crypto_key\" \"tf_states\" { name = \"terraform-state-key\" key_ring = google_kms_key_ring.tf_states.id rotation_period = \"100000s\" lifecycle { prevent_destroy = true } } resource \"google_kms_crypto_key_iam_binding\" \"binding\" { crypto_key_id = google_kms_crypto_key.tf_states.id role = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\" members = [\"serviceAccount:${data.google_storage_project_service_account.gcs_account.email_address}\"] } resource \"google_storage_bucket\" \"tf_states_bucket\" { name = \"terraform-states-${var.project_id}\" force_destroy = false location = \"us\" storage_class = \"STANDARD\" versioning { enabled = true } encryption { default_kms_key_name = \"your-crypto-key-id\" } depends_on = [google_kms_crypto_key_iam_binding.binding] lifecycle { prevent_destroy = true } } When working with Terraform, you are calling the API of the provider. With each call, you are pushing configuration to the provider. The provider will then create, update, or delete your resources.\nThat is a lot of code. Let me explain.\nFirst, I’m creating a Key(google_kms_crypto_key) and Key Ring(google_kms_key_ring) for encrypting the Terraform state file. These resources are coming from Google KMS. The service allows you to work with cryptographic keys and execute cryptographic operations.\nNext is adding the Role roles/cloudkms.cryptoKeyEncrypterDecrypter to the Service Account. Which is needed to encrypt/decrypt the state file. In the end, I’m creating a bucket for storing the Terraform state file, and I’m using the Key for encrypting the Terraform state file. There is a small gotcha. I need a Service Account for encrypting the Terraform state file. But it does not exist yet. So, I’ll use an automatic Google Cloud Storage service account to get it when the resource is created. I’m using a data resource for that.\nI’m using lifecycle.prevent_destroy to ensure the resources are not accidentally deleted.\nIf I now run the terraform plan I’ll see the following:\n$ terraform plan data.google_storage_project_service_account.gcs_account: Reading... data.google_storage_project_service_account.gcs_account: Read complete after 1s [id=service-964026605440@gs-project-accounts.iam.gserviceaccount.com] Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols: + create Terraform will perform the following actions: # google_kms_crypto_key.tf_states will be created + resource \"google_kms_crypto_key\" \"tf_states\" { + destroy_scheduled_duration = (known after apply) + id = (known after apply) + import_only = (known after apply) + key_ring = (known after apply) + name = \"terraform-state-key\" + purpose = \"ENCRYPT_DECRYPT\" + rotation_period = \"100000s\" } # google_kms_crypto_key_iam_binding.binding will be created + resource \"google_kms_crypto_key_iam_binding\" \"binding\" { + crypto_key_id = (known after apply) + etag = (known after apply) + id = (known after apply) + members = [ + \"serviceAccount:service-964026605440@gs-project-accounts.iam.gserviceaccount.com\", ] + role = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\" } # google_kms_key_ring.tf_states will be created + resource \"google_kms_key_ring\" \"tf_states\" { + id = (known after apply) + location = \"us\" + name = \"terraform-state-key-ring\" + project = (known after apply) } # google_storage_bucket.tf_states_bucket will be created + resource \"google_storage_bucket\" \"tf_states_bucket\" { + force_destroy = false + id = (known after apply) + labels = (known after apply) + location = \"US\" + name = \"terraform-states-project-id\" + project = (known after apply) + public_access_prevention = (known after apply) + self_link = (known after apply) + storage_class = \"STANDARD\" + uniform_bucket_level_access = (known after apply) + url = (known after apply) + encryption { + default_kms_key_name = \"your-crypto-key-id\" } + versioning { + enabled = true } } Plan: 4 to add, 0 to change, 0 to destroy. ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run \"terraform apply\" now. Ok, let’s try to apply the changes:\n$ terraform apply ... Plan: 4 to add, 0 to change, 0 to destroy. Do you want to perform these actions? Terraform will perform the actions described above. Only 'yes' will be accepted to approve. Enter a value: yes google_kms_key_ring.tf_states: Creating... Error: Error creating KeyRing: googleapi: Error 403: Google Cloud KMS API has not been used in project 3534534535 before or it is disabled. Enable it by visiting https://console.developers.google.com/apis/api/cloudkms.googleapis.com/overview?project=3534534535 then retry. If you enabled this API recently, wait a few minutes for the action to propagate to our systems and retry. with google_kms_key_ring.tf_states, on main.tf line 4, in resource \"google_kms_key_ring\" \"tf_states\": 4: resource \"google_kms_key_ring\" \"tf_states\" { I had to cut output. But you can see the error. I need to enable the Cloud KMS API. This will be a standard message if you try to use the API, which is not enabled. You can enable it by following the link in the error message. Or you can enable it with the following command:\n$ gcloud services enable cloudkms.googleapis.com Tip\nYou can see all the APIs you enabled with the following command:\n$ gcloud services list --enabled And list all available APIs with the following command:\n$ gcloud services list --available I already have enabled Google Storage API. But if you did not, you need to enable it, too. Try to figure out how. Ok, let’s try again:\n$ terraform apply ... Do you want to perform these actions? Terraform will perform the actions described above. Only 'yes' will be accepted to approve. Enter a value: yes google_kms_key_ring.tf_states: Creating... ╷ │ Error: Error creating KeyRing: googleapi: Error 409: KeyRing projects/project-id/locations/us/keyRings/terraform-state-key-ring already exists. │ │ with google_kms_key_ring.tf_states, │ on main.tf line 4, in resource \"google_kms_key_ring\" \"tf_states\": │ 4: resource \"google_kms_key_ring\" \"tf_states\" { I was impatient and ran terraform apply again. Google API responded that it was not enabled, but actually, it was. And not only that, it created the Key and KeyRing. This situation is rare. But it can happen. We can fix it by importing created resources. Let’s do this:\n$ terraform import google_kms_key_ring.tf_states project-id/us/terraform-state-key-ring How do I know that? Well, I read the error message and the provider’s documentation. You’ll have a section Import in Terraform documentation for each resource. There, you’ll be able to see how to import it.\nNow, let’s try again:\n$ terraform apply ... Do you want to perform these actions? Terraform will perform the actions described above. Only 'yes' will be accepted to approve. Enter a value: yes data.google_storage_project_service_account.gcs_account: Reading... google_kms_key_ring.tf_states: Refreshing state... [id=projects/project-id/locations/us/keyRings/terraform-state-key-ring] data.google_storage_project_service_account.gcs_account: Read complete after 0s [id=service-964026605440@gs-project-accounts.iam.gserviceaccount.com] google_kms_crypto_key.tf_states_key: Refreshing state... [id=projects/project-id/locations/us/keyRings/terraform-state-key-ring/cryptoKeys/terraform-states-key] google_kms_crypto_key_iam_binding.binding: Refreshing state... [id=projects/project-id/locations/us/keyRings/terraform-state-key-ring/cryptoKeys/terraform-states-key/roles/cloudkms.cryptoKeyEncrypterDecrypter] google_storage_bucket.tf_states_bucket: Creating... google_storage_bucket.tf_states_bucket: Creation complete after 2s [id=terraform-states-project-id] The bucket is created. You’ll see it if you go to GCP console. You can check bucket properties and configuration there in the console or with the following command:\n$ gsutil ls -L -b gs://terraform-states-project-id You can see that the bucket is encrypted with the Key we created. And to check the Key properties and configuration in the console or with the following command:\n$ gcloud kms keys describe terraform-states-key --location us --keyring terraform-state-key-ring You can list the content of the bucket with the command:\n$ gsutil ls gs://terraform-states-project-id But you’ll get nothing because it is empty. I still need to move Terraform’s state file to the bucket.\nSetting Up The Backend If you remember, I’m using the local backend. If you check the local directory, you’ll see a file called local-state.tfstate. That is the Terraform state file. And that file I want to move to the bucket and encrypt it there. I can do that with the following code:\nbackend \"gcs\" { bucket = \"terraform-states-project-id\" prefix = \"terraform/state\" } And removing this one in provider.tf:\nbackend \"local\" { path = \"local-state.tfstate\" } Now, if I run terraform init, I’ll see the following:\nterraform init Initializing the backend... ╷ │ Error: Backend configuration changed │ │ A change in the backend configuration has been detected, which may require migrating existing state. │ │ If you wish to attempt automatic migration of the state, use \"terraform init -migrate-state\". │ If you wish to store the current configuration with no changes to the state, use \"terraform init -reconfigure\". ╵ Well, let’s do as it says:\n$ terraform init -migrate-state When asked, type yes and wait to finish. Let’s check if we have anything in the bucket:\n$ gsutil ls gs://terraform-states-project-id/terraform/state You’ll see that the bucket has a file called default.state. That is the Terraform state file. It is encrypted. You can check it with the following command:\n$ gsutil cat gs://terraform-states-project-id/terraform/state/default.tfstate | jq . Conclusion With I just set up a project. With it, I can start exploring GCP. We touched basic Terraform CLI commands(init, plan, apply, and import), Terraform variables, provider, backend, and resources. I hope you learned something new. I know I did. I’ll continue exploring GCP with Terraform in the next article.\nReferences Google Cloud Platform Google Cloud Console Google Cloud SDK Terrafom GCP Terraform Provider ","wordCount":"2839","inLanguage":"en","image":"https://rnemet.dev/images/gcp-tf-start.png","datePublished":"2023-08-16T21:10:56+02:00","dateModified":"2023-08-16T21:10:56+02:00","author":{"@type":"Person","name":"Robert Nemet"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rnemet.dev/posts/gcp/start_with_gcp/"},"publisher":{"@type":"Organization","name":"DevCube","logo":{"@type":"ImageObject","url":"https://rnemet.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://rnemet.dev/ accesskey=h title="Home (Alt + H)"><img src=https://rnemet.dev/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://rnemet.dev/posts/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://rnemet.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://rnemet.dev/posts/practical_k8s/ title="Practical k8s"><span>Practical k8s</span></a></li><li><a href=https://rnemet.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://rnemet.dev/about/ title="About Me"><span>About Me</span></a></li><li><a href=https://rnemet.dev/ title><span></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Exploring GCP With Terraform: Setting Up The Environment And Project</h1><div class=post-description></div><div class=post-meta><span title='2023-08-16 21:10:56 +0200 CEST'>August 16, 2023</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;Robert Nemet</div></header><figure class=entry-cover><img loading=lazy src=https://rnemet.dev/images/gcp-tf-start.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#prerequisites aria-label=Prerequisites>Prerequisites</a><ul><li><a href=#create-gcp-project aria-label="Create GCP Project">Create GCP Project</a></li><li><a href=#install-and-set-up-the-gcloud-cli-tool aria-label="Install And Set Up The gcloud CLI Tool">Install And Set Up The gcloud CLI Tool</a></li><li><a href=#install-terraform-cli-tool aria-label="Install Terraform CLI Tool">Install Terraform CLI Tool</a></li><li><a href=#other-tools-i-use aria-label="Other Tools I Use">Other Tools I Use</a></li></ul></li><li><a href=#setting-up-the-project aria-label="Setting Up The Project">Setting Up The Project</a><ul><li><a href=#setting-up-provider aria-label="Setting Up Provider">Setting Up Provider</a></li><li><a href=#setting-up-variables aria-label="Setting Up Variables">Setting Up Variables</a></li><li><a href=#init-plan-and-apply aria-label="Init, Plan, and Apply">Init, Plan, and Apply</a></li><li><a href=#setting-up-the-bucket aria-label="Setting Up The Bucket">Setting Up The Bucket</a></li><li><a href=#setting-up-the-backend aria-label="Setting Up The Backend">Setting Up The Backend</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>This topic is nothing new. There are many articles and tutorials on the internet about this. I&rsquo;ll be setting up a Terraform project to explore GCP. I cover the basics of Terraform and GCP.</p><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div><svg width="0" height="0" display="none"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice warning"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"/></svg></span>Warning</p><p>I replaced the real project ID with <em>project-id</em> in the following examples. You need to replace it with your project ID.</p></div><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><h3 id=create-gcp-project>Create GCP Project<a hidden class=anchor aria-hidden=true href=#create-gcp-project>#</a></h3><p>First, you must create a GCP account, then create a project and set up billing on that project. If you already have a Gmail account, you
can use it to make a GCP account. Head to the <a href=https://console.cloud.google.com/>Google Cloud Console</a> and create a new project.</p><p>My plan is to pay for the services I use. I need to feel the pain and learn more about cost optimization. You can be more intelligent than me and use the free tier for the first year. After that,
you will be charged for the services you use. You can find more information about the <a href=https://cloud.google.com/free/docs/gcp-free-tier>free tier here</a>.</p><h3 id=install-and-set-up-the-gcloud-cli-tool>Install And Set Up The gcloud CLI Tool<a hidden class=anchor aria-hidden=true href=#install-and-set-up-the-gcloud-cli-tool>#</a></h3><p>The <code>gcloud</code> CLI is a part of the Google Cloud SDK. You can find the installation instructions for <a href=https://cloud.google.com/sdk/docs/install><code>gcloud</code> CLI here</a>.
Next, you need to set up the <code>gcloud</code> CLI tool. Docs are <a href=https://cloud.google.com/sdk/docs/initializing>here</a>.</p><p>For future reference, you can find the list of all <code>gcloud</code> commands <a href=https://cloud.google.com/sdk/gcloud/reference>here</a>.</p><p>After initialization, you can always check what you set with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud config list <span style=color:#f92672>[</span>SECTION/PROPERTY<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>--all<span style=color:#f92672>]</span>
</span></span></code></pre></div><h3 id=install-terraform-cli-tool>Install Terraform CLI Tool<a hidden class=anchor aria-hidden=true href=#install-terraform-cli-tool>#</a></h3><p>You can find the Terraform installation instructions <a href=https://learn.hashicorp.com/tutorials/terraform/install-cli>here</a>. But I&rsquo;m not following the instructions.
I&rsquo;m using the tool <a href=https://github.com/tfutils/tfenv>tfenv</a> to manage Terraform versions. Other tools can do that. You can use <a href=https://asdf-vm.com/><code>asdf</code></a>, too.
I saw that <code>asdf</code> can do more than manage Terraform versions.</p><p>Let me explain how I do it since I use <code>tfenv</code>. I assume you already installed it. I use <code>tfenv</code> to install the desired version of Terraform. And to set it as default:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tfenv install 1.5.5
</span></span><span style=display:flex><span>$ tfenv use 1.5.5
</span></span></code></pre></div><p>You can check the version with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform --version
</span></span></code></pre></div><p>I&rsquo;ll explain later why I use <code>tfenv</code>.</p><h3 id=other-tools-i-use>Other Tools I Use<a hidden class=anchor aria-hidden=true href=#other-tools-i-use>#</a></h3><p>Other tools I&rsquo;ll be using are:</p><ul><li><a href=https://taskfile.dev/>task</a> - a task runner and a replacement for <code>make</code></li><li><a href=https://git-scm.com/>git</a> - version control system</li><li><a href=https://direnv.net/>direnv</a> - unconsciously set and unset environment variables</li></ul><h2 id=setting-up-the-project>Setting Up The Project<a hidden class=anchor aria-hidden=true href=#setting-up-the-project>#</a></h2><p>I&rsquo;m using this layout for now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.                                       # project root                 
</span></span><span style=display:flex><span>├── README.md                           # project README
</span></span><span style=display:flex><span>├── LICENSE                             # project LICENSE
</span></span><span style=display:flex><span>├── .gitignore                          # project .gitignore
</span></span><span style=display:flex><span>├── Taskfile.yml                        # project taskfile
</span></span><span style=display:flex><span>└── gcp                                 # GCP Terraform code
</span></span><span style=display:flex><span>    └── base                            # base GCP Terraform code
</span></span><span style=display:flex><span>        ├── README.md                   # base README
</span></span><span style=display:flex><span>        ├── .terraform-version          # base terraform version
</span></span><span style=display:flex><span>        ├── main.tf                     # base main.tf
</span></span><span style=display:flex><span>        ├── outputs.tf                  # base outputs.tf
</span></span><span style=display:flex><span>        ├── variables.tf                # base variables.tf
</span></span><span style=display:flex><span>        ├── terraform.tfvars            # base terraform.tfvars
</span></span><span style=display:flex><span>        └── provider.tf                 # base provider.tf
</span></span></code></pre></div><p>Let me quickly explain. The <code>gcp</code> directory is the root directory for all GCP Terraform code. The <code>base</code> directory is the root directory for all base GCP Terraform code.
That base code would cover the following, for now:</p><ul><li>Creating a bucket for storing Terraform state</li><li>Creating Key and KeyRing for encrypting Terraform state file</li><li>Setting up Terraform&rsquo;s backend</li><li>Setting up Terraform provider</li><li>Setting up Terraform base variables</li></ul><p>Just create the directories and files, and we are ready to go.</p><div class="notice info"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"/></svg></span>Info</p><p>Oh, one small thing. The file <em>.terraform-version</em> is used by <em>tfenv</em> to set and pin the Terraform version. Even if I set with <em>tfenv</em> the default Terraform version,
I use this file to say which Terraform version should be used for the base. If you are using <em>tfenv</em> do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cd gcp/base
</span></span><span style=display:flex><span>$ tfenv pin
</span></span><span style=display:flex><span>Pinned version by writing <span style=color:#e6db74>&#34;1.5.5&#34;</span> to /somepath/gcp/base/.terraform-version
</span></span></code></pre></div><p>With this, it does not matter what is the default Terraform version. The <em>tfenv</em> will use the version from the <em>.terraform-version</em> file. If, for some reason, you
do not have the desired version, <em>tfenv</em> will install it for you.</p></div><h3 id=setting-up-provider>Setting Up Provider<a hidden class=anchor aria-hidden=true href=#setting-up-provider>#</a></h3><p>The first thing we need to do is to set up the provider. I&rsquo;m using the latest version of the provider. You can find the latest version <a href=https://registry.terraform.io/providers/hashicorp/google/latest>here</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;google&#34;</span> {
</span></span><span style=display:flex><span>  project <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>project_id</span>
</span></span><span style=display:flex><span>  region  <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>region</span>
</span></span><span style=display:flex><span>  zone    <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>zone</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>terraform</span> {
</span></span><span style=display:flex><span>  required_version <span style=color:#f92672>=</span> &#34;&gt;<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>5</span>.<span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>required_providers</span> {
</span></span><span style=display:flex><span>    google <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hashicorp/google&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;4.77.0&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>backend</span> <span style=color:#e6db74>&#34;local&#34;</span> {
</span></span><span style=display:flex><span>      path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;local-state.tfstate&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;m using the <code>local</code> backend for now. I plan to switch to the <code>gcs</code> backend later. The <code>local</code> backend is used for storing the Terraform state locally. The state
file is called <code>local-state.tfstate</code>. And it will contain the Terraform state for the base. It is not encrypted. My plan is to keep it safe and encrypted.</p><p>Block <code>terraform</code> sets the required Terraform provider version, provider, and backend. You can find more <a href=https://registry.terraform.io/providers/hashicorp/google/latest>here</a>.</p><p>The <code>provider</code> block configures the provider by setting the project ID, region, and zone. You probably noticed that I&rsquo;m using variables.</p><h3 id=setting-up-variables>Setting Up Variables<a hidden class=anchor aria-hidden=true href=#setting-up-variables>#</a></h3><p>I&rsquo;m using variables for defining variables I&rsquo;ll be using in the base. I&rsquo;m using the following variables:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;project_id&#34;</span> {
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;project id&#34;</span>
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;region&#34;</span> {
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default region&#34;</span>
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;zone&#34;</span> {
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default zone&#34;</span>
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Once you defined the variables, you need to set them. You can do that in the <code>terraform.tfvars</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>project_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-project&#34;</span>
</span></span><span style=display:flex><span>region     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;europe-west1&#34;</span>
</span></span><span style=display:flex><span>zone       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;europe-west1-b&#34;</span>
</span></span></code></pre></div><p>You should avoid committing the <code>terraform.tfvars</code> file. It may contain sensitive information. I&rsquo;ll show you how to handle that later.
But for now, you must create the <code>terraform.tfvars</code> file and set the variables. For the <code>project_id</code> variable, you need to set the project ID you created earlier.
Choose the region and zone that is closest to you. You can find the list of regions and zones <a href=https://cloud.google.com/compute/docs/regions-zones>here</a>.</p><div class="notice info"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#info-notice"/></svg></span>Info</p><p>Is this important? Yes, it is.</p><p>You need to choose the region and zone carefully, considering reliability, availability, and cost into account. For your users to have the best experience, your servers must be close to them and
deliver the content quickly. It would be best if you considered the cost, too.</p><p>To learn more about choosing the correct region and zone, you can find more <a href=https://cloud.google.com/solutions/best-practices-compute-engine-region-selection>here in Google documentation</a>.</p></div><h3 id=init-plan-and-apply>Init, Plan, and Apply<a hidden class=anchor aria-hidden=true href=#init-plan-and-apply>#</a></h3><p>At this moment, I can initialize the Terraform workflow:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Initializing the backend...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Successfully configured the backend <span style=color:#e6db74>&#34;local&#34;</span>! Terraform will automatically
</span></span><span style=display:flex><span>use this backend unless the backend configuration changes.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Initializing provider plugins...
</span></span><span style=display:flex><span>- Finding hashicorp/google versions matching <span style=color:#e6db74>&#34;4.77.0&#34;</span>...
</span></span><span style=display:flex><span>- Installing hashicorp/google v4.77.0...
</span></span><span style=display:flex><span>- Installed hashicorp/google v4.77.0 <span style=color:#f92672>(</span>signed by HashiCorp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform has created a lock file .terraform.lock.hcl to record the provider
</span></span><span style=display:flex><span>selections it made above. Include this file in your version control repository
</span></span><span style=display:flex><span>so that Terraform can guarantee to make the same selections by default when
</span></span><span style=display:flex><span>you run <span style=color:#e6db74>&#34;terraform init&#34;</span> in the future.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform has been successfully initialized!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You may now begin working with Terraform. Try running <span style=color:#e6db74>&#34;terraform plan&#34;</span> to see
</span></span><span style=display:flex><span>any changes that are required <span style=color:#66d9ef>for</span> your infrastructure. All Terraform commands
</span></span><span style=display:flex><span>should now work.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you ever set or change modules or backend configuration <span style=color:#66d9ef>for</span> Terraform,
</span></span><span style=display:flex><span>rerun this command to reinitialize your working directory. If you forget, other
</span></span><span style=display:flex><span>commands will detect it and remind you to <span style=color:#66d9ef>do</span> so <span style=color:#66d9ef>if</span> necessary.
</span></span></code></pre></div><p>This will create a directory <code>.terraform</code> and file <code>.terraform.lock.hcl</code> file. You should include <code>.terraform.lock.hcl</code> in your commit. It is used to lock the provider version. If you run
<code>terraform init</code> again, it will use the same provider version. The folder <code>.terraform</code> stores the provider plugins and other files required for Terraform to work.</p><p>Next, I can run <code>terraform plan</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform plan
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>No changes. Your infrastructure matches the configuration.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.
</span></span></code></pre></div><p>This will show me what Terraform will do. Since I did not create any resources, it will not do anything. But it is good to run <code>terraform plan</code> before <code>terraform apply</code>.</p><p>Next, I can run <code>terraform apply</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform apply
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>No changes. Your infrastructure matches the configuration.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply complete! Resources: <span style=color:#ae81ff>0</span> added, <span style=color:#ae81ff>0</span> changed, <span style=color:#ae81ff>0</span> destroyed.
</span></span></code></pre></div><p>Well, this is expected. I did not create any resources. If there are any changes, Terraform will show you what it will do and ask you to confirm them. If you want to apply the changes, type <code>yes</code>
and hit enter.</p><h3 id=setting-up-the-bucket>Setting Up The Bucket<a hidden class=anchor aria-hidden=true href=#setting-up-the-bucket>#</a></h3><p>From the <code>terraform init</code> output, I can see that the backend is configured. It is configured to use the <code>local</code> backend. My goal is to use the <code>gcs</code> backend. That means I want to store the
Terraform state file in the GCP bucket. Let&rsquo;s look at how to do it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;google_storage_project_service_account&#34; &#34;gcs_account&#34;</span> {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_kms_key_ring&#34; &#34;tf_states&#34;</span> {
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-state-key-ring&#34;</span>
</span></span><span style=display:flex><span>  location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>lifecycle</span> {
</span></span><span style=display:flex><span>    prevent_destroy <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_kms_crypto_key&#34; &#34;tf_states&#34;</span> {
</span></span><span style=display:flex><span>  name            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-state-key&#34;</span>
</span></span><span style=display:flex><span>  key_ring        <span style=color:#f92672>=</span> <span style=color:#66d9ef>google_kms_key_ring</span>.<span style=color:#66d9ef>tf_states</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  rotation_period <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;100000s&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>lifecycle</span> {
</span></span><span style=display:flex><span>    prevent_destroy <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_kms_crypto_key_iam_binding&#34; &#34;binding&#34;</span> {
</span></span><span style=display:flex><span>  crypto_key_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>google_kms_crypto_key</span>.<span style=color:#66d9ef>tf_states</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  role          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;roles/cloudkms.cryptoKeyEncrypterDecrypter&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  members <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;serviceAccount:${data.google_storage_project_service_account.gcs_account.email_address}&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_storage_bucket&#34; &#34;tf_states_bucket&#34;</span> {
</span></span><span style=display:flex><span>  name          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-states-${var.project_id}&#34;</span>
</span></span><span style=display:flex><span>  force_destroy <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  location      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us&#34;</span>
</span></span><span style=display:flex><span>  storage_class <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;STANDARD&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>versioning</span> {
</span></span><span style=display:flex><span>    enabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>encryption</span> {
</span></span><span style=display:flex><span>    default_kms_key_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;your-crypto-key-id&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>google_kms_crypto_key_iam_binding</span>.<span style=color:#66d9ef>binding</span>]
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>lifecycle</span> {
</span></span><span style=display:flex><span>    prevent_destroy <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When working with Terraform, you are calling the API of the provider. With each call, you are pushing configuration to the provider. The provider will then create, update,
or delete your resources.</p><p>That is a lot of code. Let me explain.</p><p>First, I&rsquo;m creating a Key(<code>google_kms_crypto_key</code>) and Key Ring(<code>google_kms_key_ring</code>) for encrypting the Terraform state file. These resources are coming from <a href=https://cloud.google.com/kms/docs>Google KMS</a>. The service allows you to work with cryptographic keys and execute cryptographic operations.</p><p>Next is adding the Role <code>roles/cloudkms.cryptoKeyEncrypterDecrypter</code> to the Service Account. Which is needed to encrypt/decrypt the state file. In the end, I&rsquo;m creating a bucket for storing the
Terraform state file, and I&rsquo;m using the Key for encrypting the Terraform state file. There is a small gotcha. I need a Service Account for encrypting the Terraform state file. But it does not exist
yet. So, I&rsquo;ll use <a href=https://cloud.google.com/storage/docs/projects#service-accounts>an automatic Google Cloud Storage service account</a> to get it when the resource is created. I&rsquo;m using a <code>data</code>
resource for that.</p><p>I&rsquo;m using <code>lifecycle.prevent_destroy</code> to ensure the resources are not accidentally deleted.</p><p>If I now run the <code>terraform plan</code> I&rsquo;ll see the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform plan
</span></span><span style=display:flex><span>data.google_storage_project_service_account.gcs_account: Reading...
</span></span><span style=display:flex><span>data.google_storage_project_service_account.gcs_account: Read complete after 1s <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>service-964026605440@gs-project-accounts.iam.gserviceaccount.com<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span style=display:flex><span>  + create
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform will perform the following actions:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># google_kms_crypto_key.tf_states will be created</span>
</span></span><span style=display:flex><span>  + resource <span style=color:#e6db74>&#34;google_kms_crypto_key&#34;</span> <span style=color:#e6db74>&#34;tf_states&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      + destroy_scheduled_duration <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + id                         <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + import_only                <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + key_ring                   <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + name                       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-state-key&#34;</span>
</span></span><span style=display:flex><span>      + purpose                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ENCRYPT_DECRYPT&#34;</span>
</span></span><span style=display:flex><span>      + rotation_period            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;100000s&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># google_kms_crypto_key_iam_binding.binding will be created</span>
</span></span><span style=display:flex><span>  + resource <span style=color:#e6db74>&#34;google_kms_crypto_key_iam_binding&#34;</span> <span style=color:#e6db74>&#34;binding&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      + crypto_key_id <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + etag          <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + id            <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + members       <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          + <span style=color:#e6db74>&#34;serviceAccount:service-964026605440@gs-project-accounts.iam.gserviceaccount.com&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      + role          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;roles/cloudkms.cryptoKeyEncrypterDecrypter&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># google_kms_key_ring.tf_states will be created</span>
</span></span><span style=display:flex><span>  + resource <span style=color:#e6db74>&#34;google_kms_key_ring&#34;</span> <span style=color:#e6db74>&#34;tf_states&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      + id       <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us&#34;</span>
</span></span><span style=display:flex><span>      + name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-state-key-ring&#34;</span>
</span></span><span style=display:flex><span>      + project  <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># google_storage_bucket.tf_states_bucket will be created</span>
</span></span><span style=display:flex><span>  + resource <span style=color:#e6db74>&#34;google_storage_bucket&#34;</span> <span style=color:#e6db74>&#34;tf_states_bucket&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      + force_destroy               <span style=color:#f92672>=</span> false
</span></span><span style=display:flex><span>      + id                          <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + labels                      <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + location                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;US&#34;</span>
</span></span><span style=display:flex><span>      + name                        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-states-project-id&#34;</span>
</span></span><span style=display:flex><span>      + project                     <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + public_access_prevention    <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + self_link                   <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + storage_class               <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;STANDARD&#34;</span>
</span></span><span style=display:flex><span>      + uniform_bucket_level_access <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      + url                         <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>known after apply<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      + encryption <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          + default_kms_key_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;your-crypto-key-id&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      + versioning <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          + enabled <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Plan: <span style=color:#ae81ff>4</span> to add, <span style=color:#ae81ff>0</span> to change, <span style=color:#ae81ff>0</span> to destroy.
</span></span><span style=display:flex><span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Note: You didn<span style=color:#e6db74>&#39;t use the -out option to save this plan, so Terraform can&#39;</span>t guarantee to take exactly these actions <span style=color:#66d9ef>if</span> you run <span style=color:#e6db74>&#34;terraform apply&#34;</span> now.  
</span></span></code></pre></div><p>Ok, let&rsquo;s try to apply the changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform apply
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Plan: <span style=color:#ae81ff>4</span> to add, <span style=color:#ae81ff>0</span> to change, <span style=color:#ae81ff>0</span> to destroy.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Do you want to perform these actions?
</span></span><span style=display:flex><span>  Terraform will perform the actions described above.
</span></span><span style=display:flex><span>  Only <span style=color:#e6db74>&#39;yes&#39;</span> will be accepted to approve.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Enter a value: yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>google_kms_key_ring.tf_states: Creating...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Error: Error creating KeyRing: googleapi: Error 403: Google Cloud KMS API has not been used in project <span style=color:#ae81ff>3534534535</span> before or it is disabled. Enable it by visiting https://console.developers.google.com/apis/api/cloudkms.googleapis.com/overview?project<span style=color:#f92672>=</span><span style=color:#ae81ff>3534534535</span> <span style=color:#66d9ef>then</span> retry. If you enabled this API recently, wait a few minutes <span style=color:#66d9ef>for</span> the action to propagate to our systems and retry.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  with google_kms_key_ring.tf_states,
</span></span><span style=display:flex><span>  on main.tf line 4, in resource <span style=color:#e6db74>&#34;google_kms_key_ring&#34;</span> <span style=color:#e6db74>&#34;tf_states&#34;</span>:
</span></span><span style=display:flex><span>   4: resource <span style=color:#e6db74>&#34;google_kms_key_ring&#34;</span> <span style=color:#e6db74>&#34;tf_states&#34;</span> <span style=color:#f92672>{</span>
</span></span></code></pre></div><p>I had to cut output. But you can see the error. I need to enable the Cloud KMS API. This will be a standard message if you try to use the API, which is not enabled.
You can enable it by following the link in the error message. Or you can enable it with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud services enable cloudkms.googleapis.com
</span></span></code></pre></div><div class="notice tip"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>Tip</p><p>You can see all the APIs you enabled with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud services list --enabled
</span></span></code></pre></div><p>And list all available APIs with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud services list --available
</span></span></code></pre></div></div><p>I already have enabled Google Storage API. But if you did not, you need to enable it, too. Try to figure out how. Ok, let&rsquo;s try again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform apply
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Do you want to perform these actions?
</span></span><span style=display:flex><span>  Terraform will perform the actions described above.
</span></span><span style=display:flex><span>  Only <span style=color:#e6db74>&#39;yes&#39;</span> will be accepted to approve.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Enter a value: yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>google_kms_key_ring.tf_states: Creating...
</span></span><span style=display:flex><span>╷
</span></span><span style=display:flex><span>│ Error: Error creating KeyRing: googleapi: Error 409: KeyRing projects/project-id/locations/us/keyRings/terraform-state-key-ring already exists.
</span></span><span style=display:flex><span>│
</span></span><span style=display:flex><span>│   with google_kms_key_ring.tf_states,
</span></span><span style=display:flex><span>│   on main.tf line 4, in resource <span style=color:#e6db74>&#34;google_kms_key_ring&#34;</span> <span style=color:#e6db74>&#34;tf_states&#34;</span>:
</span></span><span style=display:flex><span>│    4: resource <span style=color:#e6db74>&#34;google_kms_key_ring&#34;</span> <span style=color:#e6db74>&#34;tf_states&#34;</span> <span style=color:#f92672>{</span>
</span></span></code></pre></div><p>I was impatient and ran <code>terraform apply</code> again. Google API responded that it was not enabled, but actually, it was. And not only that, it created the Key and KeyRing.
This situation is rare. But it can happen. We can fix it by importing created resources. Let&rsquo;s do this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform import google_kms_key_ring.tf_states project-id/us/terraform-state-key-ring
</span></span></code></pre></div><p>How do I know that? Well, I read the error message and the provider&rsquo;s documentation. You&rsquo;ll have a section <strong>Import</strong> in Terraform documentation for each resource.
There, you&rsquo;ll be able to see how to import it.</p><p>Now, let&rsquo;s try again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform apply
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Do you want to perform these actions?
</span></span><span style=display:flex><span>  Terraform will perform the actions described above.
</span></span><span style=display:flex><span>  Only <span style=color:#e6db74>&#39;yes&#39;</span> will be accepted to approve.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Enter a value: yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>data.google_storage_project_service_account.gcs_account: Reading...
</span></span><span style=display:flex><span>google_kms_key_ring.tf_states: Refreshing state... <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>projects/project-id/locations/us/keyRings/terraform-state-key-ring<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>data.google_storage_project_service_account.gcs_account: Read complete after 0s <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>service-964026605440@gs-project-accounts.iam.gserviceaccount.com<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>google_kms_crypto_key.tf_states_key: Refreshing state... <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>projects/project-id/locations/us/keyRings/terraform-state-key-ring/cryptoKeys/terraform-states-key<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>google_kms_crypto_key_iam_binding.binding: Refreshing state... <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>projects/project-id/locations/us/keyRings/terraform-state-key-ring/cryptoKeys/terraform-states-key/roles/cloudkms.cryptoKeyEncrypterDecrypter<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>google_storage_bucket.tf_states_bucket: Creating...
</span></span><span style=display:flex><span>google_storage_bucket.tf_states_bucket: Creation complete after 2s <span style=color:#f92672>[</span>id<span style=color:#f92672>=</span>terraform-states-project-id<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>The bucket is created. You&rsquo;ll see it if you go to <a href=https://console.cloud.google.com/storage/>GCP console</a>. You can check bucket properties and configuration there in the console or with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gsutil ls -L -b gs://terraform-states-project-id
</span></span></code></pre></div><p>You can see that the bucket is encrypted with the Key we created. And to check the Key properties and configuration in the console or with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcloud kms keys describe terraform-states-key --location us --keyring terraform-state-key-ring
</span></span></code></pre></div><p>You can list the content of the bucket with the command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gsutil ls gs://terraform-states-project-id
</span></span></code></pre></div><p>But you&rsquo;ll get nothing because it is empty. I still need to move Terraform&rsquo;s state file to the bucket.</p><h3 id=setting-up-the-backend>Setting Up The Backend<a hidden class=anchor aria-hidden=true href=#setting-up-the-backend>#</a></h3><p>If you remember, I&rsquo;m using the <code>local</code> backend. If you check the local directory, you&rsquo;ll see a file called <code>local-state.tfstate</code>. That is the Terraform state file. And that file I want to move to
the bucket and encrypt it there. I can do that with the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>  <span style=color:#66d9ef>backend</span> <span style=color:#e6db74>&#34;gcs&#34;</span> {
</span></span><span style=display:flex><span>    bucket  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-states-project-id&#34;</span>
</span></span><span style=display:flex><span>    prefix  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform/state&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>And removing this one in <code>provider.tf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>  <span style=color:#66d9ef>backend</span> <span style=color:#e6db74>&#34;local&#34;</span> {
</span></span><span style=display:flex><span>    path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;local-state.tfstate&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>Now, if I run <code>terraform init</code>, I&rsquo;ll see the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Initializing the backend...
</span></span><span style=display:flex><span>╷
</span></span><span style=display:flex><span>│ Error: Backend configuration changed
</span></span><span style=display:flex><span>│
</span></span><span style=display:flex><span>│ A change in the backend configuration has been detected, which may require migrating existing state.
</span></span><span style=display:flex><span>│
</span></span><span style=display:flex><span>│ If you wish to attempt automatic migration of the state, use <span style=color:#e6db74>&#34;terraform init -migrate-state&#34;</span>.
</span></span><span style=display:flex><span>│ If you wish to store the current configuration with no changes to the state, use <span style=color:#e6db74>&#34;terraform init -reconfigure&#34;</span>.
</span></span><span style=display:flex><span>╵
</span></span></code></pre></div><p>Well, let&rsquo;s do as it says:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ terraform init -migrate-state
</span></span></code></pre></div><p>When asked, type <code>yes</code> and wait to finish. Let&rsquo;s check if we have anything in the bucket:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gsutil ls gs://terraform-states-project-id/terraform/state
</span></span></code></pre></div><p>You&rsquo;ll see that the bucket has a file called <code>default.state</code>. That is the Terraform state file. It is encrypted. You can check it with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gsutil cat gs://terraform-states-project-id/terraform/state/default.tfstate | jq .
</span></span></code></pre></div><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>With I just set up a project. With it, I can start exploring GCP. We touched basic Terraform CLI commands(<code>init</code>, <code>plan</code>, <code>apply</code>, and <code>import</code>), Terraform variables,
provider, backend, and resources. I hope you learned something new. I know I did. I&rsquo;ll continue exploring GCP with Terraform in the next article.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://cloud.google.com/>Google Cloud Platform</a></li><li><a href=https://console.cloud.google.com/>Google Cloud Console</a></li><li><a href=https://cloud.google.com/sdk/docs>Google Cloud SDK</a></li><li><a href=https://www.terraform.io/>Terrafom</a></li><li><a href=https://registry.terraform.io/providers/hashicorp/google/latest/docs>GCP Terraform Provider</a></li></ul><div class=subscribe><iframe src=https://rnemet.substack.com/embed width=480 height=320 style="border:1px solid #eee;background:#fff;margin:auto;display:block" frameborder=0 scrolling=no></iframe></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://rnemet.dev/tags/gcp/>Gcp</a></li><li><a href=https://rnemet.dev/tags/terraform/>Terraform</a></li><li><a href=https://rnemet.dev/tags/cloud/>Cloud</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: Setting Up The Environment And Project on x" href="https://x.com/intent/tweet/?text=Exploring%20GCP%20With%20Terraform%3a%20Setting%20Up%20The%20Environment%20And%20Project&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fstart_with_gcp%2f&amp;hashtags=gcp%2cterraform%2ccloud"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: Setting Up The Environment And Project on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fstart_with_gcp%2f&amp;title=Exploring%20GCP%20With%20Terraform%3a%20Setting%20Up%20The%20Environment%20And%20Project&amp;summary=Exploring%20GCP%20With%20Terraform%3a%20Setting%20Up%20The%20Environment%20And%20Project&amp;source=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fstart_with_gcp%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: Setting Up The Environment And Project on reddit" href="https://reddit.com/submit?url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fstart_with_gcp%2f&title=Exploring%20GCP%20With%20Terraform%3a%20Setting%20Up%20The%20Environment%20And%20Project"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: Setting Up The Environment And Project on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fstart_with_gcp%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: Setting Up The Environment And Project on whatsapp" href="https://api.whatsapp.com/send?text=Exploring%20GCP%20With%20Terraform%3a%20Setting%20Up%20The%20Environment%20And%20Project%20-%20https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fstart_with_gcp%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: Setting Up The Environment And Project on telegram" href="https://telegram.me/share/url?text=Exploring%20GCP%20With%20Terraform%3a%20Setting%20Up%20The%20Environment%20And%20Project&amp;url=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fstart_with_gcp%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Exploring GCP With Terraform: Setting Up The Environment And Project on ycombinator" href="https://news.ycombinator.com/submitlink?t=Exploring%20GCP%20With%20Terraform%3a%20Setting%20Up%20The%20Environment%20And%20Project&u=https%3a%2f%2frnemet.dev%2fposts%2fgcp%2fstart_with_gcp%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://rnemet.dev/>DevCube</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>